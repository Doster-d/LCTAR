# LCTAR Frontend

_Фронтенд LCTAR — система захвата AR-контента на React, React Three Fiber и связке AprilTag + AlvaAR._

Приложение обеспечивает трансляцию с камеры, детекцию AprilTag в WebAssembly, стабилизацию виртуальных объектов и запись AR-видео (с поддержкой микрофона).

## Основные возможности

- **Живой AR-композит** — `App.jsx` объединяет поток камеры, якоря по AprilTag и трёхмерные модели Three.js.
- **Гибкое управление якорями** — лучи от каждого тега, сценовые сглаживания и fallback-позиции для устойчивости трекинга.
- **Интеграция с AlvaAR** — передача данных детекции в AlvaAR для поиска и сопровождения плоскости.
- **Запись медиа** — `VideoCanvas` и `VideoCanvasManager` умеют записывать WebM/MP4 вместе с аудио.
- **Средства диагностики** — консольный оверлей, разноцветные лучи и резервный куб помогают проверять геометрию и вращения.
- **Комментарии в стиле Doxygen** — весь исходный код снабжён `@brief`, `@param`, `@returns`.

## Требования

- Node.js 18+
- npm 9+
- Современный браузер с поддержкой WebGL2, MediaRecorder и WebAssembly

Дополнительно (по желанию): Doxygen ≥ 1.9 + Graphviz для генерации документации.

## Установка и запуск

```bash
npm install          # установка зависимостей
npm run start        # dev-сервер по HTTPS на https://localhost:3000
npm run build        # продакшн-сборка в dist/
```

> **Важно:** для доступа к камере нужен защищённый origin. При первом запуске браузер попросит доверить самоподписанный сертификат dev-сервера.

## Структура каталога

```
frontend/
├── public/               # статические файлы, WASM для AprilTag, маркетинговые изображения
├── src/
│   ├── App.jsx           # основной рекордер (камера, AprilTag, UI)
│   ├── apriltagPipeline.jsx
│   ├── lib/anchorMath.js
│   ├── lib/r3f-video-recorder.jsx
│   ├── models/*.jsx      # автогенерированные GLTF-компоненты
│   └── …
├── package.json
└── webpack.config.js
```

Полезные конфиги:

- `src/apriltag-config.json` — описание сцен, размеры тегов и смещения объектов.
- `Doxyfile` — настройки Doxygen.

## Как всё работает

### Обработка AprilTag

1. `apriltagPipeline.detect()` запускает WASM-детектор и дополняет результаты матрицами, лучами и данными сцены.
2. `App.jsx` группирует теги по сценам, вычисляет пересечение лучей (least squares) и плавно обновляет положение якоря.
3. Fallback-куб всегда прикреплён к якорю — удобно проверять вращение и позицию при отладке.

### Запись видео

Модуль `lib/r3f-video-recorder.jsx` предоставляет `VideoCanvas` и `VideoCanvasManager`. Доступны два режима: `frame-accurate` (кадр-в-кадр) и `realtime` для потоковой записи.

## Генерация документации

```bash
cd frontend
doxygen Doxyfile
```

HTML-версия появится в `docs/html/` (каталог можно изменить в Doxyfile).

## Советы по отладке

- Разноцветный fallback-куб в `App.jsx` сразу показывает, «жив» ли якорь и корректно ли применяется матрица поворота.
- Лучи от AprilTag окрашиваются по ID тега; исчез луч — тег потерян.
- Пользуйтесь комментариями в коде или сгенерированной документацией для понимания API.

## Лицензии и благодарности

- GLTF-модели содержат ссылки на авторов внутри `src/models/*.jsx`.
- AprilTag WASM, OpenCV, mediabunny и three-stdlib распространяются по своим лицензиям.

Будем рады pull request'ам и вопросам: дополняйте сцены, пробуйте иную конфигурацию тегов или альтернативные пайплайны записи!