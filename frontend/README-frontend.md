@page frontend Frontend Documentation
===========
_Фронтенд LCTAR — система захвата AR-контента на React, React Three Fiber и связке AprilTag + AlvaAR._

Приложение обеспечивает трансляцию с камеры, детекцию AprilTag в WebAssembly, стабилизацию виртуальных объектов и запись AR-видео (с поддержкой микрофона).

## Основные возможности

- **Живой AR-композит** — `App.jsx` объединяет поток камеры, якоря по AprilTag и трёхмерные модели Three.js.
- **Гибкое управление якорями** — лучи от каждого тега, сценовые сглаживания и fallback-позиции для устойчивости трекинга.
- **Интеграция с AlvaAR** — передача данных детекции в AlvaAR для поиска и сопровождения плоскости.
- **Запись медиа** — `VideoCanvas` и `VideoCanvasManager` умеют записывать WebM/MP4 вместе с аудио.
- **Средства диагностики** — консольный оверлей, разноцветные лучи и резервный куб помогают проверять геометрию и вращения.
- **Комментарии в стиле Doxygen** — весь исходный код снабжён `@brief`, `@param`, `@returns`.

## Требования

- Node.js 18+
- npm 9+
- Современный браузер с поддержкой WebGL2, MediaRecorder и WebAssembly

Дополнительно (по желанию): Doxygen ≥ 1.9 + Graphviz для генерации документации.

## Установка и запуск

```bash
npm install          # установка зависимостей
npm run start        # dev-сервер по HTTPS на https://localhost:3000
npm run build        # продакшн-сборка в dist/
```

> **Важно:** для доступа к камере нужен защищённый origin. При первом запуске браузер попросит доверить самоподписанный сертификат dev-сервера.

## Структура проекта

### Обзор архитектуры

Проект построен на современной стек-технологии с использованием React для UI, Three.js для 3D-графики и WebAssembly для компьютерного зрения:

```
frontend/
├── public/                    # статические ресурсы и WASM-модули
│   ├── apriltag_wasm.js       # JavaScript мост для AprilTag детектора
│   ├── apriltag_wasm.wasm     # WebAssembly модуль для детекции маркеров
│   ├── apriltag-config.json   # конфигурация сцен и размеров тегов
│   ├── models/                # 3D модели (GLTF/GLB формат)
│   │   ├── Train-transformed.glb
│   │   └── testmodel-transformed.glb
│   ├── img/                   # изображения и маркетинговые материалы
│   └── alva/                  # интеграция с AlvaAR библиотекой
├── src/
│   ├── App.jsx                # основной компонент AR-рекордера
│   ├── index.jsx              # точка входа приложения
│   ├── apriltagPipeline.jsx   # пайплайн обработки AprilTag детекции
│   ├── SceneComponent.jsx     # компонент Three.js сцены
│   ├── Landing.jsx            # посадочная страница
│   ├── AprilTagLayoutEditor.jsx # редактор размещения тегов
│   ├── api/                   # интеграция с бэкендом
│   │   ├── client.js          # базовый HTTP клиент
│   │   └── backend.js         # API функции для Django
│   ├── data/                  # конфигурационные данные
│   │   └── assets.js          # определение активов по детекциям
│   ├── models/                # React Three Fiber компоненты моделей
│   │   ├── Train.jsx          # компонент модели поезда
│   │   └── Testmodel.jsx      # тестовые модели
│   ├── lib/                   # вспомогательные библиотеки
│   │   ├── anchorMath.js      # математические функции для якорей
│   │   └── r3f-video-recorder.jsx # система записи видео
│   ├── alvaBridge.jsx         # интеграция с AlvaAR
│   ├── trainAnimation.js      # анимационная логика поезда
│   ├── WavyGridBackground.jsx # фоновые компоненты
│   ├── DebugCube.jsx          # отладочные 3D элементы
│   └── TestModelVideoComponent.jsx # тестовые компоненты
├── config-overrides.js        # настройки Create React App
├── webpack.config.js          # кастомная конфигурация Webpack
├── package.json               # зависимости и скрипты
├── .env.example               # пример переменных окружения
└── Doxyfile                   # документация Doxygen
```

### Ключевые компоненты

**Основные модули:**
- **`App.jsx`** - центральный компонент, управляющий камерой, детекцией и UI
- **`apriltagPipeline.jsx`** - обертка над WebAssembly AprilTag детектором
- **`SceneComponent.jsx`** - интеграция React Three Fiber с Three.js сценой
- **`api/backend.js`** - функции взаимодействия с Django API

**Система детекции:**
- **AprilTag Pipeline** - детекция маркеров с субпиксельной точностью
- **AlvaAR интеграция** - улучшенное отслеживание плоскостей и поз камеры
- **Якорная система** - стабилизация виртуальных объектов в пространстве

**AR функции:**
- **Многосценарная поддержка** - разные конфигурации тегов для различных активов
- **Запись видео** - захват AR-композита с аудио в реальном времени
- **Отслеживание прогресса** - интеграция с бэкендом для учета просмотров

**Конфигурационные файлы:**
- **`apriltag-config.json`** - определение сцен, размеров тегов и смещений моделей
- **`.env`** - переменные окружения (API URL, настройки сборки)
- **`webpack.config.js`** - оптимизированная сборка с разделением чанков

## Как всё работает

### Архитектура системы

Приложение построено на модульной архитектуре с четким разделением ответственности:

**Основной поток данных:**
```
Камера → Обработка кадра → Детекция маркеров → Расчет позы → Стабилизация → Отображение → Запись
```

### Детальная обработка AprilTag

**Шаг 1: Захват и предобработка изображения**
```javascript
// Захват кадра в фиксированном разрешении для стабильной детекции
const procCanvas = createCanvas(640, 480);
const ctx = procCanvas.getContext('2d', { willReadFrequently: true });
ctx.drawImage(video, 0, 0, 640, 480);
const imageData = ctx.getImageData(0, 0, 640, 480);
```

**Шаг 2: WebAssembly детекция**
```javascript
// Вызов WASM модуля для поиска AprilTag маркеров
const detections = aprilTagPipeline.detect(imageData);
```

**Шаг 3: Постобработка детекций**
- Расчет матриц поворота для каждого маркера
- Определение лучей от камеры через центр маркера
- Группировка маркеров по сценам
- Фильтрация ложных детекций

**Алгоритм расчета позы камеры:**
```javascript
// Математическая модель для нескольких маркеров
const rays = detections.map(det => ({
  origin: cameraPosition,
  direction: calculateRayDirection(det.corners)
}));

const pose = solvePnP(rays, tagSize, cameraIntrinsics);
```

### Стабилизация трекинга

**Интерполяция якоря:**
```javascript
// Экспоненциальное сглаживание для предотвращения дрожания
const ANCHOR_LERP = 0.05;
const smoothedPosition = currentPosition.lerp(targetPosition, ANCHOR_LERP);
const smoothedRotation = currentRotation.slerp(targetRotation, ROTATION_SLERP);
```

**Компенсация задержек:**
- Предиктивное позиционирование на основе скорости движения
- Dead zone для предотвращения микрокоррекций
- Адаптивное сглаживание в зависимости от уверенности детекции

### Интеграция AlvaAR

**Улучшенное отслеживание плоскостей:**
```javascript
// Передача детекций в AlvaAR для расчета плоскости
const planeState = alvaAR.estimatePlaneFromTags({
  detections: processedDetections,
  tagSizeById: tagSizes
});

// Автоматическое позиционирование виртуальных объектов
const hitPoint = calculateHitPoint(cameraPose, planeState);
model.position.copy(hitPoint);
```

### Система координат

**Преобразования координат:**
- **Камера** → нормализованные координаты устройства (0..1)
- **OpenCV** → пиксельные координаты изображения
- **Three.js** → мировые координаты сцены (метры)
- **AprilTag** → координаты относительно центра маркера

**Матричные преобразования:**
```javascript
// OpenCV → OpenGL матрица поворота
const CV_TO_GL = new Matrix3().set(1, 0, 0, 0, -1, 0, 0, 0, -1);

// Компенсация координатных систем
const worldMatrix = opencvMatrix.clone()
  .multiplyMatrices(CV_TO_GL)
  .multiplyMatrices(cameraMatrix);
```

### Запись видео

**Архитектура записи:**
```javascript
// Создание композитного канваса
const mixCanvas = createMixCanvas();
const ctx = mixCanvas.getContext('2d');

// Захват 3D сцены
const glCanvas = renderer.domElement;

// Комбинирование слоев
ctx.drawImage(video, 0, 0, width, height);      // Фон камеры
ctx.drawImage(glCanvas, 0, 0, width, height);   // AR объекты
```

**Режимы записи:**
- **Frame-accurate** - точная синхронизация с кадровым буфером
- **Realtime** - потоковая запись с адаптивным битрейтом

**Поддержка аудио:**
```javascript
// Захват системного микрофона
const micStream = await navigator.mediaDevices.getUserMedia({
  audio: { echoCancellation: true, noiseSuppression: true }
});

// Добавление аудио к видеопотоку
const mixedStream = new MediaStream([
  ...videoStream.getTracks(),
  ...micStream.getTracks()
]);
```

## Работа с AR-контентом

### Система активов

AR-контент организован в систему активов, где каждый актив связан с определенной конфигурацией AprilTag:

**Структура актива:**
- **Slug** - уникальный идентификатор актива
- **Scene ID** - идентификатор сцены/конфигурации тегов
- **Tag ID** - конкретный AprilTag, активирующий контент
- **Название и описание** - метаданные для пользователей

**Файл конфигурации:** `src/data/assets.js` содержит маппинг детекций к активам:
```javascript
export const getAssetByDetection = (sceneId, tagId) => {
  // Возвращает актив по sceneId и tagId
}
```

### Процесс загрузки и отображения AR-моделей

1. **Детекция AprilTag** - идентификация маркера в кадре
2. **Определение актива** - сопоставление с зарегистрированным контентом
3. **Загрузка модели** - асинхронная загрузка GLTF/GLB файла
4. **Позиционирование** - размещение модели относительно маркера
5. **Стабилизация** - сглаживание движения для предотвращения дрожания

**Поддерживаемые форматы моделей:**
- **GLTF/GLB** - стандарт WebGL с поддержкой анимаций и материалов
- **PBR материалы** - физически корректное освещение
- **Анимации** - skeletal и morphing анимации
- **LOD** - уровни детализации для оптимизации

### Управление сценами

Каждая сцена определяет конфигурацию тегов и связанный с ними контент:

**Параметры сцены:**
- **Размер тегов** - физический размер AprilTag маркеров
- **Расположение моделей** - смещения относительно центра маркера
- **Ориентация** - поворот моделей в пространстве
- **Масштаб** - размер виртуальных объектов

**Пример конфигурации:**
```json
{
  "sceneId": "train-station",
  "tagSize": 0.15,
  "tags": [
    {
      "id": 0,
      "size": 0.15,
      "assetSlug": "express-train"
    }
  ]
}
```

### Оптимизация производительности

**Стратегии оптимизации:**
- **Frustum culling** - отображение только видимых объектов
- **Level of Detail (LOD)** - снижение детализации для distant объектов
- **Texture compression** - оптимизация текстур для WebGL
- **Geometry instancing** - повторное использование геометрии
- **Shader optimization** - оптимизированные шейдеры для мобильных устройств

## Настройки сборки

### Webpack конфигурация

Проект использует кастомную конфигурацию Webpack 5 для оптимальной сборки AR-приложения:

**Ключевые особенности:**
- **Раздельные чанки** - оптимизация загрузки по группам библиотек
- **WebAssembly поддержка** - интеграция AprilTag детектора
- **Hot Module Replacement** - быстрая разработка с React Fast Refresh
- **Source maps** - качественная отладка в development режиме
- **HTTPS сервер разработки** - доступ к камере без дополнительных настроек

**Структура чанков:**
```javascript
optimization: {
  splitChunks: {
    cacheGroups: {
      vendor: { test: /[\\/]node_modules[\\/]/, priority: 10 },
      opencv: { test: /[\\/]node_modules[\\/]@techstark[\\/]opencv-js[\\/]/, priority: 20 },
      three: { test: /[\\/]node_modules[\\/]three[\\/]/, priority: 20 },
      reactThree: { test: /[\\/]node_modules[\\/]@react-three[\\/]/, priority: 20 }
    }
  }
}
```

**Плагины сборки:**
- **HtmlWebpackPlugin** - генерация index.html с внедренными скриптами
- **CopyWebpackPlugin** - копирование WASM файлов и других ресурсов
- **ReactRefreshWebpackPlugin** - быстрый релоад компонентов
- **DefinePlugin** - внедрение переменных окружения

**Разрешение модулей:**
```javascript
resolve: {
  extensions: ['.js', '.jsx', '.json'],
  fallback: {
    vm: require.resolve("vm-browserify"),
    crypto: require.resolve('crypto-browserify'),
    buffer: require.resolve('buffer/'),
    stream: require.resolve('stream-browserify')
  }
}
```

**Обработка ресурсов:**
- **JavaScript/JSX** - Babel с preset-env и preset-react
- **CSS** - style-loader и css-loader для стилей
- **Изображения** - asset модули с оптимизацией размера
- **WASM файлы** - asset/resource для WebAssembly модулей

### Скрипты сборки

```bash
# Разработка с hot reload
npm start              # development сервер на https://localhost:3000

# Продакшн сборка
npm run build          # оптимизированная сборка в dist/

# Продакшн сервер
npm run start:prod     # production режим без hot reload

# Анализ бандла
npm run analyze        # генерация stats.json для анализа размера
```

### Переменные окружения

**Ключевые настройки:**
- `API_URL` - URL Django бэкенда (по умолчанию: http://localhost:8087)
- `NODE_ENV` - режим сборки (development/production)
- Настройки прокси для разработки

**Файлы окружения:**
- `.env` - актуальные переменные (не в git)
- `.env.example` - шаблон с описанием переменных

### Оптимизации производительности

**Стратегии оптимизации:**
- **Code splitting** - ленивая загрузка компонентов
- **Tree shaking** - удаление неиспользуемого кода
- **Minification** - сжатие JavaScript и CSS
- **Asset optimization** - оптимизация изображений и ресурсов
- **Caching** - долгосрочное кеширование статических ресурсов

**Размеры чанков (примерные):**
- **Vendor** (~2.1 MB) - React, Three.js, системные библиотеки
- **OpenCV** (~1.8 MB) - компьютерное зрение
- **Three.js** (~1.2 MB) - 3D графика
- **React Three Fiber** (~800 KB) - React интеграция для Three.js

### Метрики производительности

**Целевые показатели:**
- **Время загрузки** - полная инициализация за <3 секунд
- **Частота кадров** - стабильные 30+ FPS в большинстве сценариев
- **Время отклика** - реакция на движение камеры за <100мс
- **Потребление памяти** - стабильное потребление без утечек
- **Размер бандла** - оптимизированный размер для быстрой загрузки

**Измерение производительности:**
```javascript
// Web Vitals для оценки пользовательского опыта
import { getCLS, getFID, getFCP, getLCP, getTTFB } from 'web-vitals';

// Мониторинг кастомных метрик
const metrics = {
  detectionTime: measureDetectionTime(),
  renderTime: measureRenderTime(),
  memoryUsage: measureMemoryUsage()
};
```

## Производительность и оптимизация

### Оптимизация загрузки

**Стратегии загрузки ресурсов:**
- **Предзагрузка критических ресурсов** - WASM модули загружаются первыми
- **Ленивая загрузка моделей** - 3D модели загружаются по требованию
- **Code splitting** - разделение кода по маршрутам и функциональности
- **Кеширование** - долгосрочное кеширование статических ресурсов

**Оптимизация WebAssembly:**
```javascript
// Асинхронная инициализация модуля
const initAprilTag = async () => {
  const pipeline = new ApriltagPipeline();
  await pipeline.init(); // Загрузка ~1.5MB WASM кода
  return pipeline;
};

// Предзагрузка для сокращения времени инициализации
useEffect(() => {
  initAprilTag().then(setPipeline);
}, []);
```

### Оптимизация рендеринга

**Three.js оптимизации:**
- **Frustum culling** - отображение только видимых объектов
- **Level of Detail (LOD)** - разные уровни детализации для моделей
- **Texture compression** - оптимизированные текстуры для WebGL
- **Instancing** - повторное использование геометрии для одинаковых объектов

**React оптимизации:**
```javascript
// Мемоизированные компоненты для предотвращения лишних рендеров
const OptimizedModel = React.memo(({ position, rotation }) => {
  return <Model position={position} rotation={rotation} />;
});

// Использование useMemo для дорогих вычислений
const expensiveValue = useMemo(() => {
  return computeExpensiveValue(data);
}, [data]);
```

### Оптимизация детекции

**Настройки AprilTag для производительности:**
```javascript
// Баланс между скоростью и качеством детекции
const pipelineConfig = {
  quadDecimate: 2,        // Уменьшение разрешения для ускорения
  quadSigma: 0.8,         // Размытие для стабильности
  refineEdges: true,      // Улучшенная точность краев
  decodeSharpening: 0.25  // Шарпенинг для лучшей детекции
};
```

**Адаптивная обработка кадров:**
- Пропуск кадров при высокой нагрузке на CPU
- Уменьшение частоты детекции при стабильном трекинге
- Приоритетное использование GPU для вычислений

### Оптимизация памяти

**Управление памятью:**
```javascript
// Очистка ресурсов при размонтировании
useEffect(() => {
  return () => {
    geometry.dispose();
    material.dispose();
    texture.dispose();
  };
}, []);

// Мониторинг утечек памяти
const memoryCheck = () => {
  if (performance.memory) {
    console.log('Использование памяти:', {
      used: Math.round(performance.memory.usedJSHeapSize / 1048576),
      total: Math.round(performance.memory.totalJSHeapSize / 1048576),
      limit: Math.round(performance.memory.jsHeapSizeLimit / 1048576)
    });
  }
};
```

### Мобильная оптимизация

**Адаптация для мобильных устройств:**
- **Автоматическое качество** - снижение настроек графики на слабых устройствах
- **Энергосбережение** - паузы в обработке при неактивности приложения
- **Сенсорная оптимизация** - адаптация интерфейса для touch управления

**Детекция возможностей устройства:**
```javascript
const deviceCapabilities = {
  isMobile: /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),
  hasWebGL2: checkWebGL2Support(),
  maxTextureSize: getMaxTextureSize(),
  memoryLimit: estimateMemoryLimit()
};

// Адаптивная конфигурация
const config = deviceCapabilities.isMobile
  ? mobileConfig
  : desktopConfig;
```

### Мониторинг и аналитика

**Сбор метрик производительности:**
- **Core Web Vitals** - стандартные метрики Google
- **Кастомные метрики** - специфичные для AR функции
- **Ошибка отслеживание** - мониторинг сбоев и проблем
- **Пользовательская аналитика** - поведение пользователей в AR сценах

**Инструменты мониторинга:**
- **Performance Observer** - отслеживание метрик в реальном времени
- **Web Workers** - фоновый анализ без блокировки UI
- **Service Workers** - кеширование и оффлайн функциональность

**Профилирование в продакшене:**
```javascript
// Легковесное профилирование без влияния на производительность
const profiler = {
  start: (name) => {
    if (process.env.NODE_ENV === 'development') {
      console.time(name);
    }
  },
  end: (name) => {
    if (process.env.NODE_ENV === 'development') {
      console.timeEnd(name);
    }
  }
};
```

## Генерация документации

```bash
cd frontend
doxygen Doxyfile
```

HTML-версия появится в `docs/html/` (каталог можно изменить в Doxyfile).

## Интеграция с бэкендом

### Django API интеграция

Frontend взаимодействует с Django-бэкендом через REST API для управления сессиями, отслеживания прогресса и получения промокодов:

**Основные функции API:**
- **Управление сессиями** - создание и отслеживание пользовательских сессий
- **Отслеживание активов** - автоматическая отправка событий просмотра AR-контента
- **Система промокодов** - получение наград за просмотр активов
- **Статистика** - сбор данных о взаимодействии с контентом
- **Пользовательские данные** - привязка email адресов к сессиям

**Конфигурация API:**
```javascript
// src/api/client.js
const API_BASE_URL = 'http://localhost:8087';
```

**Доступные эндпоинты:**
- `POST /session/start/` - создание новой сессии
- `POST /view/` - отправка события просмотра актива
- `POST /user/email/` - привязка email к сессии
- `GET /progress/?session_id={id}` - получение прогресса сессии
- `GET /promo/?session_id={id}` - получение промокода по сессии
- `GET /stats/` - общая статистика
- `GET /health/` - проверка доступности сервиса

### Автоматическая интеграция

При детекции AprilTag приложение автоматически:
1. Определяет актив по конфигурации сцены
2. Отправляет событие просмотра на бэкенд
3. Обновляет локальный прогресс
4. Проверяет доступность промокодов

## Лучшие практики разработки

### Структура кода

**Организация компонентов:**
- Разделяйте сложные компоненты на меньшие переиспользуемые части
- Используйте кастомные хуки для логики, не связанной с UI
- Избегайте глубоких вложенностей компонентов (>5 уровней)

**Стили кода:**
- Используйте функциональные компоненты с хуками вместо классов
- Предпочитайте деструктуризацию объектов и массивов
- Избегайте мутаций состояния, используйте неизменяемые обновления

### Работа с Three.js

**Производительность:**
```javascript
// Правильно: используйте requestAnimationFrame для анимаций
useFrame((state, delta) => {
  mesh.current.rotation.y += delta * 0.5;
});

// Неправильно: используйте setInterval для анимаций
setInterval(() => {
  mesh.current.rotation.y += 0.1;
}, 16);
```

**Управление памятью:**
- Всегда очищайте геометрию и материалы при размонтировании компонентов
- Используйте `useMemo` для дорогих вычислений геометрии
- Предзагружайте критически важные ресурсы

### AR-разработка

**Калибровка камеры:**
- Тестируйте на разных устройствах для определения оптимальных параметров
- Учитывайте distortion камеры при расчете позиций
- Калибруйте focal length для повышения точности детекции

**Стабилизация трекинга:**
- Используйте фильтры низких частот для сглаживания движения
- Реализуйте предиктивное отслеживание для компенсации задержек
- Настраивайте dead zone для предотвращения микродвижений

### Отладка и тестирование

**Стратегии отладки:**
- Используйте React DevTools Profiler для анализа производительности
- Мониторьте память с помощью Chrome DevTools Memory tab
- Логируйте ключевые события для анализа поведения в продакшене

**Тестирование:**
- Тестируйте на реальных устройствах с разными характеристиками камеры
- Проверяйте работу в различных условиях освещения
- Тестируйте интеграцию с бэкендом в разных сетевых условиях

### Безопасность

**WebRTC безопасность:**
- Всегда запрашивайте разрешения пользователя для доступа к камере
- Проверяйте поддержку функций перед использованием
- Обрабатывайте ошибки доступа к медиа-устройствам

**API безопасность:**
- Валидируйте все данные перед отправкой на сервер
- Используйте HTTPS для всех API вызовов
- Обрабатывайте ошибки аутентификации и авторизации

## Кроссбраузерная поддержка

### Поддерживаемые браузеры

**Полная поддержка (рекомендуется):**
- **Chrome 88+** - лучшая поддержка WebGL и WebAssembly
- **Firefox 85+** - хорошая поддержка с некоторыми ограничениями WebGL
- **Safari 14+** - поддержка на macOS и iOS (ограничения камеры)
- **Edge 88+** - полная поддержка на базе Chromium

**Ограниченная поддержка:**
- **Chrome 70-87** - основные функции работают, возможны проблемы с WebGL2
- **Safari 12-13** - ограниченная поддержка WebAssembly и MediaRecorder
- **Firefox 70-84** - возможны проблемы с производительностью

### Web APIs совместимость

**Критичные APIs:**
- **WebGL2** - аппаратное ускорение 3D графики
- **WebAssembly** - детекция AprilTag маркеров
- **MediaDevices.getUserMedia** - доступ к камере
- **MediaRecorder** - запись видео с аудио
- **WebRTC** - захват медиа-потоков

**Проверка поддержки:**
```javascript
// Проверка WebGL2
const canvas = document.createElement('canvas');
const gl = canvas.getContext('webgl2');
if (!gl) {
  throw new Error('WebGL2 не поддерживается');
}

// Проверка MediaRecorder
if (!window.MediaRecorder) {
  throw new Error('MediaRecorder не поддерживается');
}

// Проверка WebAssembly
if (!window.WebAssembly) {
  throw new Error('WebAssembly не поддерживается');
}
```

### Мобильная поддержка

**iOS Safari:**
- Требует HTTPS для доступа к камере
- Ограничения на использование микрофона в фоне
- WebGL производительность ниже десктопной версии
- Рекомендуется добавлять в homescreen для лучшей производительности

**Android Chrome:**
- Хорошая поддержка WebGL и WebAssembly
- Стабильный доступ к камере и микрофону
- Возможны проблемы с производительностью на старых устройствах

### Фallback стратегии

**Для старых браузеров:**
- Предупреждение о необходимости обновления браузера
- Предложение альтернативных способов использования
- Проверка и предложение обновления до последней версии

**Для ограниченной функциональности:**
- Отключение записи видео при отсутствии MediaRecorder
- Использование WebGL1 вместо WebGL2 (снижение качества)
- Альтернативные методы детекции без WebAssembly

### Тестирование

**Кроссбраузерное тестирование:**
- Тестируйте на разных версиях браузеров
- Проверяйте работу на мобильных устройствах
- Тестируйте в различных условиях сети
- Используйте browserstack или similarweb для удаленного тестирования

**Матрица поддержки функций:**

| Функция | Chrome | Firefox | Safari | Edge |
|---------|--------|---------|---------|------|
| WebGL2 | ✅ 88+ | ✅ 85+ | ✅ 14+ | ✅ 88+ |
| WebAssembly | ✅ 57+ | ✅ 52+ | ✅ 11+ | ✅ 79+ |
| MediaRecorder | ✅ 47+ | ✅ 25+ | ✅ 14+ | ✅ 79+ |
| getUserMedia | ✅ 53+ | ✅ 36+ | ✅ 11+ | ✅ 79+ |

## Советы по отладке

### Визуальная отладка

**Элементы отладки в приложении:**
- **Разноцветный debug-куб** - показывает позицию и ориентацию якоря в реальном времени
- **Цветные лучи от тегов** - визуализация детекции каждого AprilTag маркера
- **AlvaAR точки** - зеленые точки показывают детекцию точек интереса
- **Красные точки** - точки пересечения лучей с предполагаемой плоскостью

**Интерпретация визуальных сигналов:**
```javascript
// Цвета лучей соответствуют ID тегов (детерминированная палитра)
const getRayColor = (tagId) => {
  const hue = ((tagId ?? 0) * 0.173) % 1; // Золотое сечение для разнообразия
  return new THREE.Color().setHSL(hue, 0.68, 0.53);
};
```

**Отладочные режимы:**
- **Fallback куб** - всегда отображается при потере трекинга
- **Микродвижения** - визуализация мелких корректировок позиции
- **Матрицы поворота** - отображение текущей матрицы трансформации

### Отладка производительности

**Инструменты анализа:**
```javascript
// React DevTools Profiler - анализ рендеров компонентов
// Chrome DevTools Performance - анализ кадров в секунду
// Memory tab - мониторинг утечек памяти

// Логирование производительности
const t0 = performance.now();
// ... код для профилирования
console.log(`Операция заняла ${performance.now() - t0}мс`);
```

**Метрики производительности:**
- **FPS** - целевой показатель 30+ кадров в секунду
- **Время детекции** - AprilTag обработка должна занимать <50мс
- **Потребление памяти** - мониторинг роста памяти во времени
- **Время загрузки** - модели должны загружаться за <3 секунд

### Отладка камеры и медиа

**Проблемы с камерой:**
```javascript
// Проверка поддержки устройств
const devices = await navigator.mediaDevices.enumerateDevices();
const videoDevices = devices.filter(d => d.kind === 'videoinput');

// Диагностика разрешения камеры
videoTrack.getSettings(); // Текущие настройки
videoTrack.getConstraints(); // Запрошенные ограничения

// Обработка ошибок камеры
try {
  const stream = await navigator.mediaDevices.getUserMedia(constraints);
} catch (error) {
  switch (error.name) {
    case 'NotAllowedError':
      console.error('Пользователь запретил доступ к камере');
      break;
    case 'NotFoundError':
      console.error('Камера не найдена');
      break;
    case 'NotReadableError':
      console.error('Камера занята другим приложением');
      break;
  }
}
```

**Калибровка камеры:**
- Проверьте параметры фокусного расстояния в настройках AprilTag
- Убедитесь в правильности размеров тегов в конфигурации
- Тестируйте на разных расстояниях от камеры

### Отладка AprilTag детекции

**Диагностика детекции:**
```javascript
// Логирование сырых детекций
console.log('Детекции:', detections.map(d => ({
  id: d.id,
  corners: d.corners,
  center: d.center,
  hamming: d.hamming,
  confidence: d.confidence
})));

// Проверка качества детекции
const goodDetections = detections.filter(d => d.hamming === 0);
const avgConfidence = detections.reduce((sum, d) => sum + d.confidence, 0) / detections.length;
```

**Настройка параметров детекции:**
- **Разрешение** - фиксированные 640x480 для стабильности
- **Контрастность** - достаточное освещение маркеров
- **Угол наклона** - маркеры не должны быть сильно искажены
- **Расстояние** - оптимальное расстояние для размера тегов

### Отладка API интеграции

**Мониторинг сетевых запросов:**
```javascript
// Логирование всех API запросов
const originalFetch = window.fetch;
window.fetch = function(...args) {
  console.log('API запрос:', args[0], args[1]);
  return originalFetch.apply(this, args);
};

// Отслеживание состояния сессии
console.log('Session ID:', sessionIdRef.current);
console.log('Progress:', progressState);
console.log('API Error:', apiError);
```

**Обработка ошибок API:**
- **Сетевые ошибки** - проверка доступности бэкенда
- **Ошибки авторизации** - проверка валидности сессии
- **Ошибки валидации** - проверка корректности отправляемых данных
- **Таймауты** - обработка медленных соединений

### Отладка WebAssembly

**Диагностика WASM модулей:**
```javascript
// Проверка загрузки модуля
try {
  const pipeline = new ApriltagPipeline();
  await pipeline.init();
  console.log('WASM модуль загружен успешно');
} catch (error) {
  console.error('Ошибка загрузки WASM:', error);
}

// Мониторинг производительности WASM
const t0 = performance.now();
const detections = await pipeline.detect(imageData);
console.log(`Детекция заняла ${performance.now() - t0}мс`);
```

### Расширенные инструменты отладки

**Расширения браузера:**
- **React DevTools** - инспекция компонентов и профилирование
- **Three.js Inspector** - визуализация 3D сцены и геометрии
- **WebGL Inspector** - анализ WebGL вызовов и производительности
- **Network Throttling** - симуляция медленного интернета

**Локальная разработка:**
- Используйте `npm run analyze` для анализа размера бандла
- Мониторьте консоль на наличие warning'ов и error'ов
- Проверяйте память на утечки при длительной работе
- Тестируйте на разных устройствах и браузерах

**Логирование в продакшене:**
```javascript
// Условное логирование только в development
if (process.env.NODE_ENV === 'development') {
  console.log('Отладочная информация');
}
```

## Лицензии и благодарности

- GLTF-модели содержат ссылки на авторов внутри `src/models/*.jsx`.
- AprilTag WASM, OpenCV, mediabunny и three-stdlib распространяются по своим лицензиям.

Будем рады pull request'ам и вопросам: дополняйте сцены, пробуйте иную конфигурацию тегов или альтернативные пайплайны записи!