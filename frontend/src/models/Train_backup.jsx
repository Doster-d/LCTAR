/*
Auto-generated by: https://github.com/pmndrs/gltfjsx
Command: npx gltfjsx@6.5.3 public/models/Train.glb -o src/models/Train.jsx -T 
Files: public/models/Train.glb [8.46KB] > E:\source\repos\LCTAR\frontend\src\models\Train-transformed.glb [8.53KB] (-1%)
*/

import React, { forwardRef, useEffect, useRef } from 'react'
import { useFrame } from '@react-three/fiber'
import { useGLTF } from '@react-three/drei'

/**
 * @brief –°—Ç–∞—Ç–∏—á–Ω–∞—è –º–æ–¥–µ–ª—å –ø–æ–µ–∑–¥–∞ –¥–ª—è –≤–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏–∏ –º–∞—Ä–∫–µ—Ä–æ–≤.
 * @param props –ü—Ä–æ–±—Ä–æ—à–µ–Ω–Ω—ã–µ –ø—Ä–æ–ø—Å—ã –≥—Ä—É–ø–ø—ã –¥–ª—è –ø–æ–∑–∏—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏—è.
 * @returns {JSX.Element} –ù–∞–±–æ—Ä –º–µ—à–µ–π –ø–æ–µ–∑–¥–∞.
 */
export const Model = forwardRef((props, ref) => {
  const { nodes, materials } = useGLTF('./models/Train-transformed.glb')
  console.log('üöÇ Train model loaded:', { nodes: Object.keys(nodes), materials: Object.keys(materials) });
  const wheelRef = useRef()
  const timeRef = useRef(0)
  const baseRef = useRef(null)

  // –î–æ–±–∞–≤–ª—è–µ–º —Ä–µ—Ñ –∏ —Ç–∞–π–º–µ—Ä –¥–ª—è –≤—Å–µ–π –º–æ–¥–µ–ª–∏
  const groupRef = useRef(null)
  const groupBaseRef = useRef(null)
  const groupTimeRef = useRef(0)

  useEffect(() => {
    if (!ref) return
    if (typeof ref === 'function') ref(groupRef.current)
    else ref.current = groupRef.current
  }, [ref])

  useFrame((_, delta) => {
    const wheel = wheelRef.current
    const group = groupRef.current
    if (!wheel && !group) return

    if (wheel && !baseRef.current) {
      baseRef.current = {
        x: wheel.position.x,
        y: wheel.position.y,
        z: wheel.position.z
      }
    }

    if (group && !groupBaseRef.current) {
      groupBaseRef.current = {
        x: group.position.x,
        y: group.position.y,
        z: group.position.z,
        rotX: group.rotation.x,
        rotY: group.rotation.y,
        rotZ: group.rotation.z
      }
    }

    // –ê–Ω–∏–º–∞—Ü–∏—è –∫–æ–ª–µ—Å: —Ç–æ–ª—å–∫–æ –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ–µ (–≤–≤–µ—Ä—Ö‚Äë–≤–Ω–∏–∑) –¥–≤–∏–∂–µ–Ω–∏–µ
    timeRef.current = (timeRef.current + delta * 0.3) % 1
    const t = timeRef.current
    const amplitude = 0.008 // —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞ –¥–≤–∏–∂–µ–Ω–∏—è –ø–æ Y –¥–ª—è –∫–æ–ª–µ—Å
    const offsetY = Math.sin(t * Math.PI * 2) * amplitude
    if (wheel) wheel.position.y = baseRef.current.y + offsetY

    // –ê–Ω–∏–º–∞—Ü–∏—è –≤—Å–µ–π –º–æ–¥–µ–ª–∏: –º—è–≥–∫–æ–µ –≤–≤–µ—Ä—Ö‚Äë–≤–Ω–∏–∑ –∏ –Ω–µ–±–æ–ª—å—à–æ–π –Ω–∞–∫–ª–æ–Ω
    groupTimeRef.current += delta
    const gt = groupTimeRef.current
    const groupAmp = 0.01 // —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞ –¥–ª—è –≤—Å–µ–π –º–æ–¥–µ–ª–∏ (–ø–æ Y)
    const groupOffsetY = Math.sin(gt * 0.8) * groupAmp
    const tiltAmp = 0.008 // —É–º–µ–Ω—å—à–µ–Ω–Ω–∞—è –∞–º–ø–ª–∏—Ç—É–¥–∞ –Ω–∞–∫–ª–æ–Ω–∞ (–≤ —Ä–∞–¥–∏–∞–Ω–∞—Ö)
    const tilt = Math.sin(gt * 0.6) * tiltAmp

    if (group && groupBaseRef.current) {
      group.position.y = groupBaseRef.current.y + groupOffsetY
      // –ù–µ–±–æ–ª—å—à–æ–π –Ω–∞–∫–ª–æ–Ω –≤–æ–∫—Ä—É–≥ Z (–∏–ª–∏ X/Y ‚Äî –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)
      group.rotation.z = groupBaseRef.current.rotZ + tilt
    }
  })

  return (
    <group ref={groupRef} {...props} dispose={null}>
      {/* –ö–æ—Ä—Ä–µ–∫—Ü–∏—è –æ—Ä–∏–µ–Ω—Ç–∞—Ü–∏–∏: –ø–æ–≤–æ—Ä–æ—Ç –Ω–∞ 180¬∞ –ø–æ X —á—Ç–æ–±—ã –ø–æ–µ–∑–¥ –±—ã–ª –ø—Ä–∞–≤–∏–ª—å–Ω–æ –æ—Ä–∏–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω */}
      <group rotation={[Math.PI, 0, 0]}>
        <mesh geometry={nodes['Train-Mat2'].geometry} material={materials['Mat.2']} position={[0.001, 0.26, 0.014]} />
        <mesh geometry={nodes['Train-Wagon'].geometry} material={materials.Wagon} position={[0.001, 0.26, 0.014]} />
        <mesh ref={wheelRef} geometry={nodes['Train-Wheels'].geometry} material={materials.Wheels} position={[0.001, 0.26, 0.014]} />
      </group>
      <mesh geometry={nodes['Train-Wagon'].geometry} material={materials.Wagon} position={[0.001, 0.26, 0.014]} />
      <mesh ref={wheelRef} geometry={nodes['Train-Wheels'].geometry} material={materials.Wheels} position={[0.001, 0.26, 0.014]} />
    </group>
  )
})

/**
 * @brief –ü—Ä–µ–¥–≤–∞—Ä–∏—Ç–µ–ª—å–Ω–æ –∑–∞–≥—Ä—É–∂–∞–µ—Ç GLTF-–º–æ–¥–µ–ª—å –ø–æ–µ–∑–¥–∞ –¥–ª—è —Ä–µ–Ω–¥–µ—Ä–∞.
 */
useGLTF.preload('./models/Train-transformed.glb')
