@startuml
title LCTAR - Quest Flow (Sequence)

actor "Посетитель" as Visitor #87CEFA
participant "Frontend (React)" as Frontend #98FB98
participant "Backend (FastAPI)" as Backend #FFA07A
participant "AprilTag Pipeline (WASM)" as AprilTag #AFEEEE
participant "Gamification Service" as Gamification #FFFACD
database "Database" as DB #FFE4E1

== QR scan & session start ==
Visitor -> Frontend: Сканирование QR (открытие ссылки)
activate Frontend
Frontend -> Backend: POST /api/quest/start
activate Backend
Backend -> DB: CREATE quest_session
DB --> Backend: session_id
Backend --> Frontend: 200 OK (session_id, quest_data)
deactivate Backend
Frontend --> Visitor: Показ интерфейса
deactivate Frontend

== Language selection ==
Visitor -> Frontend: Выбор языка
activate Frontend
Frontend -> Backend: POST /api/user/preferences
activate Backend
Backend -> DB: UPDATE user_preferences
DB --> Backend: OK
Backend --> Frontend: 200 OK (translations)
deactivate Backend
Frontend --> Visitor: Интерфейс обновлён
deactivate Frontend

== AprilTag detection ==
Visitor -> Frontend: Наведение камеры на AprilTag
activate Frontend
Frontend -> AprilTag: processFrame(image)
activate AprilTag
AprilTag -> AprilTag: Определение через WASM
AprilTag --> Frontend: detection (tag_id, pose)
deactivate AprilTag
Frontend -> Backend: POST /api/quest/checkpoint
activate Backend
Backend -> DB: SELECT checkpoint by tag_id
DB --> Backend: checkpoint_info
Backend --> Frontend: 200 OK (ar_content)
deactivate Backend
deactivate Frontend

== AR interaction & rewards ==
Frontend -> Frontend: Инициация AR-сцены, загрузка 3D-модели
Visitor -> Frontend: Взаимодействие с AR
activate Frontend
Frontend -> Gamification: requestInteractionReward
activate Gamification
Gamification -> DB: Прочтение/обновление прогресса и токенов
DB --> Gamification: updated
Gamification --> Frontend: reward_granted
deactivate Gamification
Frontend --> Visitor: Обновление интерфейса
deactivate Frontend

== Quest completion and coupon ==
Visitor -> Frontend: Окончание квеста
activate Frontend
Frontend -> Backend: POST /api/quest/complete
activate Backend
Backend -> DB: валидация прогресса, генерация купона
DB --> Backend: coupon_data
Backend --> Frontend: 200 OK (coupon, qr)
deactivate Backend
Frontend --> Visitor: Показ QR-кода купона
deactivate Frontend

' Styling
skinparam backgroundColor #F8F9FA
skinparam participantBackgroundColor #FFFFFF
skinparam defaultFontName "DejaVu Sans"

legend right
  |= Компонент |= Описание |
  | #87CEFA | Посетитель |
  | #98FB98 | Frontend (React) |
  | #FFA07A | Backend (FastAPI) |
  | #AFEEEE | AprilTag (WASM) |
  | #FFFACD | Gamification |
endlegend

@enduml