<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>plan.md — Web viewer</title>
  <link rel="stylesheet" href="/web-md/style.css" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/styles/github.min.css">
</head>
<body>
  <div id="app">
    <header class="topbar">
      <h1>plan.md</h1>
      <nav>
        <!-- Сделать ссылку сразу рабочей на notes/plan.md -->
        <a id="rawLink" href="/notes/plan.md" target="_blank" rel="noopener">Raw</a>
      </nav>
    </header>

    <main id="content">Загрузка...</main>

    <footer class="foot">Откройте эту страницу с телефона: http://&lt;ваш‑локальный‑IP&gt;:8080/web-md/</footer>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/highlight.js/11.8.0/highlight.min.js"></script>
  <script>
    (function(){
      const MD_PATH = './plan.md';
      const contentEl = document.getElementById('content');

      function wrapImagesWithFigure(root){
        // Оборачиваем img в figure и добавляем figcaption из alt/title
        const imgs = Array.from(root.querySelectorAll('img'));
        imgs.forEach(img => {
          // если уже внутри figure — пропускаем
          if (img.closest('figure')) return;
          const fig = document.createElement('figure');
          const parent = img.parentNode;
          parent.replaceChild(fig, img);
          fig.appendChild(img);
          const captionText = img.getAttribute('alt') || img.getAttribute('title') || '';
          if (captionText.trim()) {
            const cap = document.createElement('figcaption');
            cap.textContent = captionText;
            fig.appendChild(cap);
          }
        });
      }

      async function load() {
        try {
          const res = await fetch(MD_PATH, {cache: 'no-store'});
          if (!res.ok) throw new Error(res.status + ' ' + res.statusText);
          const md = await res.text();
          contentEl.innerHTML = marked.parse(md, {gfm: true, breaks: true});
          document.querySelectorAll('pre code').forEach(el=>hljs.highlightElement(el));
          // Пост-обработка изображений
          wrapImagesWithFigure(contentEl);
        } catch (e) {
          console.error(e);
          contentEl.textContent = 'Ошибка: не удалось загрузить ' + MD_PATH + ' — ' + e.message;
        }
      }

      if (document.readyState === 'complete' || document.readyState === 'interactive') load();
      else document.addEventListener('DOMContentLoaded', load);
    })();
  </script>
</body>
</html>
