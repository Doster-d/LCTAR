<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "https://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="ru">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=11"/>
<meta name="generator" content="Doxygen 1.14.0"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>LCTAR Backend: Пространство имен arb.views</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<script type="text/javascript" src="clipboard.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript" src="cookie.js"></script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr id="projectrow">
  <td id="projectalign">
   <div id="projectname">LCTAR Backend<span id="projectnumber">&#160;0.1</span>
   </div>
   <div id="projectbrief">Документация кода (Django + DRF + Celery)</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Создано системой Doxygen 1.14.0 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search/",'.html');
</script>
<script type="text/javascript">
$(function() { codefold.init(); });
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Поиск',true);
  $(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(function(){initNavTree('namespacearb_1_1views.html','',''); });
</script>
<div id="container">
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<div id="MSearchResults">
<div class="SRPage">
<div id="SRIndex">
<div id="SRResults"></div>
<div class="SRStatus" id="Loading">Загрузка...</div>
<div class="SRStatus" id="Searching">Поиск...</div>
<div class="SRStatus" id="NoMatches">Не найдено</div>
</div>
</div>
</div>
</div>

<div class="header">
  <div class="headertitle"><div class="title">Пространство имен arb.views</div></div>
</div><!--header-->
<div class="contents">
<table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-func-members" class="groupheader"><a id="func-members" name="func-members"></a>
Функции</h2></td></tr>
<tr class="memitem:ad88af802e68434b14102c85e279899cd" id="r_ad88af802e68434b14102c85e279899cd"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ad88af802e68434b14102c85e279899cd">health_check</a> (_request)</td></tr>
<tr class="memitem:a010c8b79b0b91c78729ae5e74254facb" id="r_a010c8b79b0b91c78729ae5e74254facb"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a010c8b79b0b91c78729ae5e74254facb">_compute_session_viewed_count</a> (<a class="el" href="classarb_1_1models_1_1_session.html">Session</a> session)</td></tr>
<tr class="memitem:a0ac8d10e3bdf4cd11b7109b0b3841425" id="r_a0ac8d10e3bdf4cd11b7109b0b3841425"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a0ac8d10e3bdf4cd11b7109b0b3841425">_compute_user_total_score</a> (<a class="el" href="classarb_1_1models_1_1_user.html">User</a> user)</td></tr>
<tr class="memitem:a487cc2aa7159af4772de92c2ff70e063" id="r_a487cc2aa7159af4772de92c2ff70e063"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a487cc2aa7159af4772de92c2ff70e063">_issue_promocode_if_completed</a> (<a class="el" href="classarb_1_1models_1_1_session.html">Session</a> session, bool return_existing=True)</td></tr>
<tr class="memitem:ae8a05126432f17a87e63324baa176a92" id="r_ae8a05126432f17a87e63324baa176a92"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ae8a05126432f17a87e63324baa176a92">session_start</a> (request)</td></tr>
<tr class="memitem:a6019b86cf7f3207de1daababecf3fd05" id="r_a6019b86cf7f3207de1daababecf3fd05"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a6019b86cf7f3207de1daababecf3fd05">view_event</a> (request)</td></tr>
<tr class="memitem:a5e599b8ed90c3b72ba2ed946841f2675" id="r_a5e599b8ed90c3b72ba2ed946841f2675"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a5e599b8ed90c3b72ba2ed946841f2675">user_email</a> (request)</td></tr>
<tr class="memitem:ac3da9a1ba3cf4a705077bb9c80860902" id="r_ac3da9a1ba3cf4a705077bb9c80860902"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#ac3da9a1ba3cf4a705077bb9c80860902">progress</a> (request)</td></tr>
<tr class="memitem:a826304bffc5d3442e1d63605579cad46" id="r_a826304bffc5d3442e1d63605579cad46"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a826304bffc5d3442e1d63605579cad46">promo</a> (request)</td></tr>
<tr class="memitem:a93773621fe9a5a1d8efa020d57926a97" id="r_a93773621fe9a5a1d8efa020d57926a97"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a93773621fe9a5a1d8efa020d57926a97">stats</a> (_request)</td></tr>
</table><table class="memberdecls">
<tr class="heading"><td colspan="2"><h2 id="header-var-members" class="groupheader"><a id="var-members" name="var-members"></a>
Переменные</h2></td></tr>
<tr class="memitem:a9c8988c8437bedf9564fca3d5c0767d2" id="r_a9c8988c8437bedf9564fca3d5c0767d2"><td class="memItemLeft" align="right" valign="top">&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a9c8988c8437bedf9564fca3d5c0767d2">logger</a> = logging.getLogger(__name__)</td></tr>
<tr class="memitem:a3f26b2a1ff2af012cb33d6edde8aaffe" id="r_a3f26b2a1ff2af012cb33d6edde8aaffe"><td class="memItemLeft" align="right" valign="top">int&#160;</td><td class="memItemRight" valign="bottom"><a class="el" href="#a3f26b2a1ff2af012cb33d6edde8aaffe">FIRST_VIEW_POINTS</a> = 10</td></tr>
</table>
<a name="details" id="details"></a><h2 id="header-details" class="groupheader">Подробное описание</h2>
<div class="textblock"><pre class="fragment">@file views.py
@brief Публичные API-обработчики и бизнес-логика MVP.

Содержит представления (DRF function-based views) для старта сессии,
регистрации событий просмотра, привязки email, получения прогресса,
выдачи промокодов и сводных статистик. Вспомогательные функции
инкапсулируют вычисление очков и условий выдачи промокода.
</pre> </div><a name="doc-func-members" id="doc-func-members"></a><h2 id="header-doc-func-members" class="groupheader">Функции</h2>
<a id="a010c8b79b0b91c78729ae5e74254facb" name="a010c8b79b0b91c78729ae5e74254facb"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a010c8b79b0b91c78729ae5e74254facb">&#9670;&#160;</a></span>_compute_session_viewed_count()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"> int arb.views._compute_session_viewed_count </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classarb_1_1models_1_1_session.html">Session</a></td>          <td class="paramname"><span class="paramname"><em>session</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel protected">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<pre class="fragment">@brief Количество просмотренных (хотя бы один раз) активов в сессии.

@param session: Объект `Session`
@return Число уникальных активов с `times_viewed &gt; 0`.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00050">50</a></p>
<div class="fragment"><div class="line"><span class="lineno">   50</span><span class="keyword">def </span>_compute_session_viewed_count(session: Session) -&gt; int:</div>
<div class="line"><span class="lineno">   51</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   52</span><span class="stringliteral">    @brief Количество просмотренных (хотя бы один раз) активов в сессии.</span></div>
<div class="line"><span class="lineno">   53</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   54</span><span class="stringliteral">    @param session: Объект `Session`</span></div>
<div class="line"><span class="lineno">   55</span><span class="stringliteral">    @return Число уникальных активов с `times_viewed &gt; 0`.</span></div>
<div class="line"><span class="lineno">   56</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   57</span>    <span class="keywordflow">return</span> (</div>
<div class="line"><span class="lineno">   58</span>        SessionItemProgress.objects.filter(session=session, times_viewed__gt=0)</div>
<div class="line"><span class="lineno">   59</span>        .only(<span class="stringliteral">&quot;id&quot;</span>)</div>
<div class="line"><span class="lineno">   60</span>        .count()</div>
<div class="line"><span class="lineno">   61</span>    )</div>
<div class="line"><span class="lineno">   62</span> </div>
<div class="line"><span class="lineno">   63</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a0ac8d10e3bdf4cd11b7109b0b3841425" name="a0ac8d10e3bdf4cd11b7109b0b3841425"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a0ac8d10e3bdf4cd11b7109b0b3841425">&#9670;&#160;</a></span>_compute_user_total_score()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname"> int arb.views._compute_user_total_score </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classarb_1_1models_1_1_user.html">User</a></td>          <td class="paramname"><span class="paramname"><em>user</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel protected">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<pre class="fragment">@brief Пересчёт общего балла пользователя.

@details Суммирует уникальные активы, просмотренные в любых сессиях
пользователя, и умножает на константу `FIRST_VIEW_POINTS`.

@param user: Объект `User`
@return Число очков.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00064">64</a></p>
<div class="fragment"><div class="line"><span class="lineno">   64</span><span class="keyword">def </span>_compute_user_total_score(user: User) -&gt; int:</div>
<div class="line"><span class="lineno">   65</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   66</span><span class="stringliteral">    @brief Пересчёт общего балла пользователя.</span></div>
<div class="line"><span class="lineno">   67</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   68</span><span class="stringliteral">    @details Суммирует уникальные активы, просмотренные в любых сессиях</span></div>
<div class="line"><span class="lineno">   69</span><span class="stringliteral">    пользователя, и умножает на константу `FIRST_VIEW_POINTS`.</span></div>
<div class="line"><span class="lineno">   70</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   71</span><span class="stringliteral">    @param user: Объект `User`</span></div>
<div class="line"><span class="lineno">   72</span><span class="stringliteral">    @return Число очков.</span></div>
<div class="line"><span class="lineno">   73</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   74</span>    unique_viewed_assets = (</div>
<div class="line"><span class="lineno">   75</span>        SessionItemProgress.objects.filter(session__user=user, times_viewed__gt=0)</div>
<div class="line"><span class="lineno">   76</span>        .values_list(<span class="stringliteral">&quot;asset_id&quot;</span>, flat=<span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">   77</span>        .distinct()</div>
<div class="line"><span class="lineno">   78</span>        .count()</div>
<div class="line"><span class="lineno">   79</span>    )</div>
<div class="line"><span class="lineno">   80</span>    <span class="keywordflow">return</span> unique_viewed_assets * FIRST_VIEW_POINTS</div>
<div class="line"><span class="lineno">   81</span> </div>
<div class="line"><span class="lineno">   82</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="a487cc2aa7159af4772de92c2ff70e063" name="a487cc2aa7159af4772de92c2ff70e063"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a487cc2aa7159af4772de92c2ff70e063">&#9670;&#160;</a></span>_issue_promocode_if_completed()</h2>

<div class="memitem">
<div class="memproto">
<table class="mlabels">
  <tr>
  <td class="mlabels-left">
      <table class="memname">
        <tr>
          <td class="memname">arb.views._issue_promocode_if_completed </td>
          <td>(</td>
          <td class="paramtype"><a class="el" href="classarb_1_1models_1_1_session.html">Session</a></td>          <td class="paramname"><span class="paramname"><em>session</em></span>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">bool </td>          <td class="paramname"><span class="paramname"><em>return_existing</em></span><span class="paramdefsep"> = </span><span class="paramdefval">True</span>&#160;)</td>
        </tr>
      </table>
  </td>
  <td class="mlabels-right">
<span class="mlabels"><span class="mlabel protected">protected</span></span>  </td>
  </tr>
</table>
</div><div class="memdoc">
<pre class="fragment">@brief Выдаёт промокод, если сессия просмотрела все активы.

@param session: Объект `Session`
@param return_existing: Возвращать ли ранее неиспользованный промокод
@return Код промо или None.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00083">83</a></p>
<div class="fragment"><div class="line"><span class="lineno">   83</span><span class="keyword">def </span>_issue_promocode_if_completed(session: Session, return_existing: bool = <span class="keyword">True</span>):</div>
<div class="line"><span class="lineno">   84</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   85</span><span class="stringliteral">    @brief Выдаёт промокод, если сессия просмотрела все активы.</span></div>
<div class="line"><span class="lineno">   86</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   87</span><span class="stringliteral">    @param session: Объект `Session`</span></div>
<div class="line"><span class="lineno">   88</span><span class="stringliteral">    @param return_existing: Возвращать ли ранее неиспользованный промокод</span></div>
<div class="line"><span class="lineno">   89</span><span class="stringliteral">    @return Код промо или None.</span></div>
<div class="line"><span class="lineno">   90</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   91</span>    total_assets = Asset.objects.count()</div>
<div class="line"><span class="lineno">   92</span>    <span class="keywordflow">if</span> total_assets == 0:</div>
<div class="line"><span class="lineno">   93</span>        <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">   94</span>    viewed = _compute_session_viewed_count(session)</div>
<div class="line"><span class="lineno">   95</span>    <span class="keywordflow">if</span> viewed &lt; total_assets:</div>
<div class="line"><span class="lineno">   96</span>        <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">   97</span>    existing = session.promo_codes.filter(used_at__isnull=<span class="keyword">True</span>).first()</div>
<div class="line"><span class="lineno">   98</span>    <span class="keywordflow">if</span> existing:</div>
<div class="line"><span class="lineno">   99</span>        <span class="keywordflow">if</span> return_existing:</div>
<div class="line"><span class="lineno">  100</span>            ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  101</span>                session=session,</div>
<div class="line"><span class="lineno">  102</span>                asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  103</span>                event_type=<span class="stringliteral">&quot;promo_issued&quot;</span>,</div>
<div class="line"><span class="lineno">  104</span>                raw_payload={<span class="stringliteral">&quot;code&quot;</span>: existing.code, <span class="stringliteral">&quot;existing&quot;</span>: <span class="keyword">True</span>},</div>
<div class="line"><span class="lineno">  105</span>            )</div>
<div class="line"><span class="lineno">  106</span>            <span class="keywordflow">return</span> existing.code</div>
<div class="line"><span class="lineno">  107</span>        <span class="keywordflow">return</span> <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  108</span>    code = f<span class="stringliteral">&quot;PROMO-{session.id.hex[:8].upper()}-{timezone.now().strftime(&#39;%H%M%S&#39;)}&quot;</span></div>
<div class="line"><span class="lineno">  109</span>    promo = PromoCode.objects.create(</div>
<div class="line"><span class="lineno">  110</span>        code=code,</div>
<div class="line"><span class="lineno">  111</span>        session=session,</div>
<div class="line"><span class="lineno">  112</span>        user=session.user <span class="keywordflow">if</span> session.user_id <span class="keywordflow">else</span> <span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  113</span>        email=(session.user.email <span class="keywordflow">if</span> session.user_id <span class="keywordflow">else</span> session.pending_email),</div>
<div class="line"><span class="lineno">  114</span>        issued_at=timezone.now(),</div>
<div class="line"><span class="lineno">  115</span>    )</div>
<div class="line"><span class="lineno">  116</span>    ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  117</span>        session=session,</div>
<div class="line"><span class="lineno">  118</span>        asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  119</span>        event_type=<span class="stringliteral">&quot;promo_issued&quot;</span>,</div>
<div class="line"><span class="lineno">  120</span>        raw_payload={<span class="stringliteral">&quot;code&quot;</span>: promo.code, <span class="stringliteral">&quot;existing&quot;</span>: <span class="keyword">False</span>},</div>
<div class="line"><span class="lineno">  121</span>    )</div>
<div class="line"><span class="lineno">  122</span>    <span class="keywordflow">return</span> promo.code</div>
<div class="line"><span class="lineno">  123</span> </div>
<div class="line"><span class="lineno">  124</span> </div>
<div class="line"><span class="lineno">  125</span><span class="preprocessor">@api_view([&quot;POST&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="ad88af802e68434b14102c85e279899cd" name="ad88af802e68434b14102c85e279899cd"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ad88af802e68434b14102c85e279899cd">&#9670;&#160;</a></span>health_check()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.health_check </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>_request</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">@brief Простой health-check.

@param _request: HTTP-запрос
@return Текстовое сообщение из конфигурации `HEALTH_MESSAGE`.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00037">37</a></p>
<div class="fragment"><div class="line"><span class="lineno">   37</span><span class="keyword">def </span>health_check(_request):</div>
<div class="line"><span class="lineno">   38</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   39</span><span class="stringliteral">    @brief Простой health-check.</span></div>
<div class="line"><span class="lineno">   40</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">   41</span><span class="stringliteral">    @param _request: HTTP-запрос</span></div>
<div class="line"><span class="lineno">   42</span><span class="stringliteral">    @return Текстовое сообщение из конфигурации `HEALTH_MESSAGE`.</span></div>
<div class="line"><span class="lineno">   43</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">   44</span>    <span class="keywordflow">return</span> HttpResponse(</div>
<div class="line"><span class="lineno">   45</span>        settings.HEALTH_MESSAGE,</div>
<div class="line"><span class="lineno">   46</span>        content_type=<span class="stringliteral">&quot;text/plain&quot;</span>,</div>
<div class="line"><span class="lineno">   47</span>    )</div>
<div class="line"><span class="lineno">   48</span> </div>
<div class="line"><span class="lineno">   49</span> </div>
</div><!-- fragment -->
</div>
</div>
<a id="ac3da9a1ba3cf4a705077bb9c80860902" name="ac3da9a1ba3cf4a705077bb9c80860902"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ac3da9a1ba3cf4a705077bb9c80860902">&#9670;&#160;</a></span>progress()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.progress </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>request</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">@brief Возвращает прогресс по сессии или пользователю.

@param request: Query `session_id` или `user_id`
@return Общее число активов, просмотренные и оставшиеся, и очки.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00242">242</a></p>
<div class="fragment"><div class="line"><span class="lineno">  242</span><span class="keyword">def </span>progress(request):</div>
<div class="line"><span class="lineno">  243</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  244</span><span class="stringliteral">    @brief Возвращает прогресс по сессии или пользователю.</span></div>
<div class="line"><span class="lineno">  245</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  246</span><span class="stringliteral">    @param request: Query `session_id` или `user_id`</span></div>
<div class="line"><span class="lineno">  247</span><span class="stringliteral">    @return Общее число активов, просмотренные и оставшиеся, и очки.</span></div>
<div class="line"><span class="lineno">  248</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  249</span>    session_id = request.query_params.get(<span class="stringliteral">&quot;session_id&quot;</span>)</div>
<div class="line"><span class="lineno">  250</span>    user_id = request.query_params.get(<span class="stringliteral">&quot;user_id&quot;</span>)</div>
<div class="line"><span class="lineno">  251</span>    <span class="keywordflow">if</span> <span class="keywordflow">not</span> session_id <span class="keywordflow">and</span> <span class="keywordflow">not</span> user_id:</div>
<div class="line"><span class="lineno">  252</span>        <span class="keywordflow">return</span> Response({<span class="stringliteral">&quot;detail&quot;</span>: <span class="stringliteral">&quot;session_id or user_id is required&quot;</span>}, status=400)</div>
<div class="line"><span class="lineno">  253</span>    total_assets = Asset.objects.count()</div>
<div class="line"><span class="lineno">  254</span>    <span class="keywordflow">if</span> session_id:</div>
<div class="line"><span class="lineno">  255</span>        session = get_object_or_404(Session, id=session_id)</div>
<div class="line"><span class="lineno">  256</span>        viewed_assets = _compute_session_viewed_count(session)</div>
<div class="line"><span class="lineno">  257</span>        payload = {</div>
<div class="line"><span class="lineno">  258</span>            <span class="stringliteral">&quot;total_assets&quot;</span>: total_assets,</div>
<div class="line"><span class="lineno">  259</span>            <span class="stringliteral">&quot;viewed_assets&quot;</span>: viewed_assets,</div>
<div class="line"><span class="lineno">  260</span>            <span class="stringliteral">&quot;remaining_assets&quot;</span>: max(total_assets - viewed_assets, 0),</div>
<div class="line"><span class="lineno">  261</span>            <span class="stringliteral">&quot;total_score&quot;</span>: session.score,</div>
<div class="line"><span class="lineno">  262</span>        }</div>
<div class="line"><span class="lineno">  263</span>        ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  264</span>            session=session,</div>
<div class="line"><span class="lineno">  265</span>            asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  266</span>            event_type=<span class="stringliteral">&quot;progress_viewed&quot;</span>,</div>
<div class="line"><span class="lineno">  267</span>            raw_payload=payload,</div>
<div class="line"><span class="lineno">  268</span>        )</div>
<div class="line"><span class="lineno">  269</span>        <span class="keywordflow">return</span> Response(payload)</div>
<div class="line"><span class="lineno">  270</span>    user = get_object_or_404(User, id=user_id)</div>
<div class="line"><span class="lineno">  271</span>    user_score = _compute_user_total_score(user)</div>
<div class="line"><span class="lineno">  272</span>    <span class="keywordflow">if</span> user.total_score != user_score:</div>
<div class="line"><span class="lineno">  273</span>        user.total_score = user_score</div>
<div class="line"><span class="lineno">  274</span>        user.save(update_fields=[<span class="stringliteral">&quot;total_score&quot;</span>])</div>
<div class="line"><span class="lineno">  275</span>    viewed_assets = (</div>
<div class="line"><span class="lineno">  276</span>        SessionItemProgress.objects.filter(session__user=user, times_viewed__gt=0)</div>
<div class="line"><span class="lineno">  277</span>        .values_list(<span class="stringliteral">&quot;asset_id&quot;</span>, flat=<span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  278</span>        .distinct()</div>
<div class="line"><span class="lineno">  279</span>        .count()</div>
<div class="line"><span class="lineno">  280</span>    )</div>
<div class="line"><span class="lineno">  281</span>    <span class="keywordflow">return</span> Response(</div>
<div class="line"><span class="lineno">  282</span>        {</div>
<div class="line"><span class="lineno">  283</span>            <span class="stringliteral">&quot;total_assets&quot;</span>: total_assets,</div>
<div class="line"><span class="lineno">  284</span>            <span class="stringliteral">&quot;viewed_assets&quot;</span>: viewed_assets,</div>
<div class="line"><span class="lineno">  285</span>            <span class="stringliteral">&quot;remaining_assets&quot;</span>: max(total_assets - viewed_assets, 0),</div>
<div class="line"><span class="lineno">  286</span>            <span class="stringliteral">&quot;total_score&quot;</span>: user.total_score,</div>
<div class="line"><span class="lineno">  287</span>        }</div>
<div class="line"><span class="lineno">  288</span>    )</div>
<div class="line"><span class="lineno">  289</span> </div>
<div class="line"><span class="lineno">  290</span> </div>
<div class="line"><span class="lineno">  291</span><span class="preprocessor">@api_view([&quot;GET&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a826304bffc5d3442e1d63605579cad46" name="a826304bffc5d3442e1d63605579cad46"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a826304bffc5d3442e1d63605579cad46">&#9670;&#160;</a></span>promo()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.promo </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>request</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">@brief Возвращает активный промокод для пользователя/сессии, если он есть.

@param request: Query `session_id` или `user_id` или `email`
@return JSON с `promo_code` либо 404, если условия не выполнены.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00292">292</a></p>
<div class="fragment"><div class="line"><span class="lineno">  292</span><span class="keyword">def </span>promo(request):</div>
<div class="line"><span class="lineno">  293</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  294</span><span class="stringliteral">    @brief Возвращает активный промокод для пользователя/сессии, если он есть.</span></div>
<div class="line"><span class="lineno">  295</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  296</span><span class="stringliteral">    @param request: Query `session_id` или `user_id` или `email`</span></div>
<div class="line"><span class="lineno">  297</span><span class="stringliteral">    @return JSON с `promo_code` либо 404, если условия не выполнены.</span></div>
<div class="line"><span class="lineno">  298</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  299</span>    session_id = request.query_params.get(<span class="stringliteral">&quot;session_id&quot;</span>)</div>
<div class="line"><span class="lineno">  300</span>    user_id = request.query_params.get(<span class="stringliteral">&quot;user_id&quot;</span>)</div>
<div class="line"><span class="lineno">  301</span>    email = request.query_params.get(<span class="stringliteral">&quot;email&quot;</span>)</div>
<div class="line"><span class="lineno">  302</span> </div>
<div class="line"><span class="lineno">  303</span>    <span class="keywordflow">if</span> <span class="keywordflow">not</span> any([session_id, user_id, email]):</div>
<div class="line"><span class="lineno">  304</span>        <span class="keywordflow">return</span> Response(</div>
<div class="line"><span class="lineno">  305</span>            {<span class="stringliteral">&quot;detail&quot;</span>: <span class="stringliteral">&quot;session_id or user_id or email is required&quot;</span>}, status=400</div>
<div class="line"><span class="lineno">  306</span>        )</div>
<div class="line"><span class="lineno">  307</span> </div>
<div class="line"><span class="lineno">  308</span>    user = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  309</span>    session = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  310</span> </div>
<div class="line"><span class="lineno">  311</span>    <span class="keywordflow">if</span> session_id:</div>
<div class="line"><span class="lineno">  312</span>        session = get_object_or_404(Session, id=session_id)</div>
<div class="line"><span class="lineno">  313</span>        user = session.user</div>
<div class="line"><span class="lineno">  314</span>    <span class="keywordflow">elif</span> user_id:</div>
<div class="line"><span class="lineno">  315</span>        user = get_object_or_404(User, id=user_id)</div>
<div class="line"><span class="lineno">  316</span>    <span class="keywordflow">elif</span> email:</div>
<div class="line"><span class="lineno">  317</span>        user = User.objects.filter(email=email).first()</div>
<div class="line"><span class="lineno">  318</span>        <span class="keywordflow">if</span> <span class="keywordflow">not</span> user:</div>
<div class="line"><span class="lineno">  319</span>            <span class="keywordflow">return</span> Response({<span class="stringliteral">&quot;detail&quot;</span>: <span class="stringliteral">&quot;not_found&quot;</span>}, status=404)</div>
<div class="line"><span class="lineno">  320</span> </div>
<div class="line"><span class="lineno">  321</span>    existing_promo = PromoCode.objects.filter(user=user, used_at__isnull=<span class="keyword">True</span>).first()</div>
<div class="line"><span class="lineno">  322</span>    <span class="keywordflow">if</span> existing_promo:</div>
<div class="line"><span class="lineno">  323</span>        <span class="keywordflow">if</span> session:</div>
<div class="line"><span class="lineno">  324</span>            result = <span class="stringliteral">&quot;issued&quot;</span> <span class="keywordflow">if</span> existing_promo.session_id == session.id <span class="keywordflow">else</span> <span class="stringliteral">&quot;exists&quot;</span></div>
<div class="line"><span class="lineno">  325</span>            ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  326</span>                session=session,</div>
<div class="line"><span class="lineno">  327</span>                asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  328</span>                event_type=<span class="stringliteral">&quot;promo_checked&quot;</span>,</div>
<div class="line"><span class="lineno">  329</span>                raw_payload={<span class="stringliteral">&quot;result&quot;</span>: result, <span class="stringliteral">&quot;code&quot;</span>: existing_promo.code},</div>
<div class="line"><span class="lineno">  330</span>            )</div>
<div class="line"><span class="lineno">  331</span>        <span class="keywordflow">return</span> Response({<span class="stringliteral">&quot;promo_code&quot;</span>: existing_promo.code})</div>
<div class="line"><span class="lineno">  332</span> </div>
<div class="line"><span class="lineno">  333</span>    <span class="keywordflow">if</span> <span class="keywordflow">not</span> session:</div>
<div class="line"><span class="lineno">  334</span>        session = Session.objects.filter(user=user).order_by(<span class="stringliteral">&quot;-last_seen&quot;</span>).first()</div>
<div class="line"><span class="lineno">  335</span> </div>
<div class="line"><span class="lineno">  336</span>    <span class="keywordflow">if</span> session:</div>
<div class="line"><span class="lineno">  337</span>        code = _issue_promocode_if_completed(session, return_existing=<span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  338</span>        <span class="keywordflow">if</span> code:</div>
<div class="line"><span class="lineno">  339</span>            ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  340</span>                session=session,</div>
<div class="line"><span class="lineno">  341</span>                asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  342</span>                event_type=<span class="stringliteral">&quot;promo_checked&quot;</span>,</div>
<div class="line"><span class="lineno">  343</span>                raw_payload={<span class="stringliteral">&quot;result&quot;</span>: <span class="stringliteral">&quot;issued&quot;</span>, <span class="stringliteral">&quot;code&quot;</span>: code},</div>
<div class="line"><span class="lineno">  344</span>            )</div>
<div class="line"><span class="lineno">  345</span>            <span class="keywordflow">return</span> Response({<span class="stringliteral">&quot;promo_code&quot;</span>: code})</div>
<div class="line"><span class="lineno">  346</span> </div>
<div class="line"><span class="lineno">  347</span>    <span class="keywordflow">if</span> session:</div>
<div class="line"><span class="lineno">  348</span>        ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  349</span>            session=session,</div>
<div class="line"><span class="lineno">  350</span>            asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  351</span>            event_type=<span class="stringliteral">&quot;promo_checked&quot;</span>,</div>
<div class="line"><span class="lineno">  352</span>            raw_payload={<span class="stringliteral">&quot;result&quot;</span>: <span class="stringliteral">&quot;not_completed&quot;</span>},</div>
<div class="line"><span class="lineno">  353</span>        )</div>
<div class="line"><span class="lineno">  354</span>    <span class="keywordflow">return</span> Response({<span class="stringliteral">&quot;detail&quot;</span>: <span class="stringliteral">&quot;not_completed&quot;</span>}, status=404)</div>
<div class="line"><span class="lineno">  355</span> </div>
<div class="line"><span class="lineno">  356</span> </div>
<div class="line"><span class="lineno">  357</span><span class="preprocessor">@api_view([&quot;GET&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="ae8a05126432f17a87e63324baa176a92" name="ae8a05126432f17a87e63324baa176a92"></a>
<h2 class="memtitle"><span class="permalink"><a href="#ae8a05126432f17a87e63324baa176a92">&#9670;&#160;</a></span>session_start()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.session_start </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>request</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">@brief Создаёт новую сессию и логирует событие старта.

@param request: HTTP-запрос без тела
@return Идентификатор созданной сессии.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00126">126</a></p>
<div class="fragment"><div class="line"><span class="lineno">  126</span><span class="keyword">def </span>session_start(request):  <span class="comment"># noqa: ARG001</span></div>
<div class="line"><span class="lineno">  127</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  128</span><span class="stringliteral">    @brief Создаёт новую сессию и логирует событие старта.</span></div>
<div class="line"><span class="lineno">  129</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  130</span><span class="stringliteral">    @param request: HTTP-запрос без тела</span></div>
<div class="line"><span class="lineno">  131</span><span class="stringliteral">    @return Идентификатор созданной сессии.</span></div>
<div class="line"><span class="lineno">  132</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  133</span>    session = Session.objects.create(last_seen=timezone.now(), is_active=<span class="keyword">True</span>)</div>
<div class="line"><span class="lineno">  134</span>    ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  135</span>        session=session,</div>
<div class="line"><span class="lineno">  136</span>        asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  137</span>        event_type=<span class="stringliteral">&quot;session_started&quot;</span>,</div>
<div class="line"><span class="lineno">  138</span>        raw_payload={<span class="stringliteral">&quot;event&quot;</span>: <span class="stringliteral">&quot;session_started&quot;</span>},</div>
<div class="line"><span class="lineno">  139</span>    )</div>
<div class="line"><span class="lineno">  140</span>    <span class="keywordflow">return</span> Response({<span class="stringliteral">&quot;session_id&quot;</span>: str(session.id)}, status=status.HTTP_201_CREATED)</div>
<div class="line"><span class="lineno">  141</span> </div>
<div class="line"><span class="lineno">  142</span> </div>
<div class="line"><span class="lineno">  143</span><span class="preprocessor">@api_view([&quot;POST&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a93773621fe9a5a1d8efa020d57926a97" name="a93773621fe9a5a1d8efa020d57926a97"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a93773621fe9a5a1d8efa020d57926a97">&#9670;&#160;</a></span>stats()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.stats </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>_request</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">@brief Сводная статистика просмотров и «лучший» актив за сегодня.

@details Находит актив по комбинированному скорингу из долей:
сегодняшние просмотры, «первым в сессии», и суммарные просмотры.

@param _request: HTTP-запрос
@return JSON с `best_asset`, `views_today`, `views_all_time`.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00358">358</a></p>
<div class="fragment"><div class="line"><span class="lineno">  358</span><span class="keyword">def </span>stats(_request):</div>
<div class="line"><span class="lineno">  359</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  360</span><span class="stringliteral">    @brief Сводная статистика просмотров и «лучший» актив за сегодня.</span></div>
<div class="line"><span class="lineno">  361</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  362</span><span class="stringliteral">    @details Находит актив по комбинированному скорингу из долей:</span></div>
<div class="line"><span class="lineno">  363</span><span class="stringliteral">    сегодняшние просмотры, «первым в сессии», и суммарные просмотры.</span></div>
<div class="line"><span class="lineno">  364</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  365</span><span class="stringliteral">    @param _request: HTTP-запрос</span></div>
<div class="line"><span class="lineno">  366</span><span class="stringliteral">    @return JSON с `best_asset`, `views_today`, `views_all_time`.</span></div>
<div class="line"><span class="lineno">  367</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  368</span>    today = timezone.localdate()</div>
<div class="line"><span class="lineno">  369</span>    base_filter = {<span class="stringliteral">&quot;event_type&quot;</span>: <span class="stringliteral">&quot;viewed_asset&quot;</span>, <span class="stringliteral">&quot;asset__isnull&quot;</span>: <span class="keyword">False</span>}</div>
<div class="line"><span class="lineno">  370</span>    views_all_time = ViewEvent.objects.filter(**base_filter).count()</div>
<div class="line"><span class="lineno">  371</span>    views_today_qs = ViewEvent.objects.filter(timestamp__date=today, **base_filter)</div>
<div class="line"><span class="lineno">  372</span>    views_today = views_today_qs.count()</div>
<div class="line"><span class="lineno">  373</span> </div>
<div class="line"><span class="lineno">  374</span>    best_asset_payload = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  375</span>    <span class="keywordflow">if</span> views_today == 0:</div>
<div class="line"><span class="lineno">  376</span>        all_counts_qs = (</div>
<div class="line"><span class="lineno">  377</span>            ViewEvent.objects.filter(**base_filter)</div>
<div class="line"><span class="lineno">  378</span>            .values(<span class="stringliteral">&quot;asset_id&quot;</span>)</div>
<div class="line"><span class="lineno">  379</span>            .annotate(cnt=Count(<span class="stringliteral">&quot;id&quot;</span>))</div>
<div class="line"><span class="lineno">  380</span>            .order_by(<span class="stringliteral">&quot;-cnt&quot;</span>)</div>
<div class="line"><span class="lineno">  381</span>        )</div>
<div class="line"><span class="lineno">  382</span>        <span class="keywordflow">if</span> all_counts_qs.exists():</div>
<div class="line"><span class="lineno">  383</span>            best_asset_id = all_counts_qs.first()[<span class="stringliteral">&quot;asset_id&quot;</span>]</div>
<div class="line"><span class="lineno">  384</span>            asset = Asset.objects.get(id=best_asset_id)</div>
<div class="line"><span class="lineno">  385</span>            best_asset_payload = {<span class="stringliteral">&quot;slug&quot;</span>: asset.slug, <span class="stringliteral">&quot;name&quot;</span>: asset.name}</div>
<div class="line"><span class="lineno">  386</span>    <span class="keywordflow">else</span>:</div>
<div class="line"><span class="lineno">  387</span>        today_counts_qs = views_today_qs.values(<span class="stringliteral">&quot;asset_id&quot;</span>).annotate(cnt=Count(<span class="stringliteral">&quot;id&quot;</span>))</div>
<div class="line"><span class="lineno">  388</span>        today_counts = {row[<span class="stringliteral">&quot;asset_id&quot;</span>]: row[<span class="stringliteral">&quot;cnt&quot;</span>] <span class="keywordflow">for</span> row <span class="keywordflow">in</span> today_counts_qs}</div>
<div class="line"><span class="lineno">  389</span> </div>
<div class="line"><span class="lineno">  390</span>        all_counts_qs = (</div>
<div class="line"><span class="lineno">  391</span>            ViewEvent.objects.filter(**base_filter)</div>
<div class="line"><span class="lineno">  392</span>            .values(<span class="stringliteral">&quot;asset_id&quot;</span>)</div>
<div class="line"><span class="lineno">  393</span>            .annotate(cnt=Count(<span class="stringliteral">&quot;id&quot;</span>))</div>
<div class="line"><span class="lineno">  394</span>        )</div>
<div class="line"><span class="lineno">  395</span>        all_counts = {row[<span class="stringliteral">&quot;asset_id&quot;</span>]: row[<span class="stringliteral">&quot;cnt&quot;</span>] <span class="keywordflow">for</span> row <span class="keywordflow">in</span> all_counts_qs}</div>
<div class="line"><span class="lineno">  396</span> </div>
<div class="line"><span class="lineno">  397</span>        first_asset_sub = (</div>
<div class="line"><span class="lineno">  398</span>            ViewEvent.objects.filter(session=OuterRef(<span class="stringliteral">&quot;pk&quot;</span>), **base_filter)</div>
<div class="line"><span class="lineno">  399</span>            .order_by(<span class="stringliteral">&quot;timestamp&quot;</span>)</div>
<div class="line"><span class="lineno">  400</span>            .values(<span class="stringliteral">&quot;asset_id&quot;</span>)[:1]</div>
<div class="line"><span class="lineno">  401</span>        )</div>
<div class="line"><span class="lineno">  402</span>        firsts_qs = (</div>
<div class="line"><span class="lineno">  403</span>            Session.objects.annotate(first_asset_id=Subquery(first_asset_sub))</div>
<div class="line"><span class="lineno">  404</span>            .values(<span class="stringliteral">&quot;first_asset_id&quot;</span>)</div>
<div class="line"><span class="lineno">  405</span>            .exclude(first_asset_id=<span class="keywordtype">None</span>)</div>
<div class="line"><span class="lineno">  406</span>            .annotate(cnt=Count(<span class="stringliteral">&quot;id&quot;</span>))</div>
<div class="line"><span class="lineno">  407</span>        )</div>
<div class="line"><span class="lineno">  408</span>        first_counts = {row[<span class="stringliteral">&quot;first_asset_id&quot;</span>]: row[<span class="stringliteral">&quot;cnt&quot;</span>] <span class="keywordflow">for</span> row <span class="keywordflow">in</span> firsts_qs}</div>
<div class="line"><span class="lineno">  409</span> </div>
<div class="line"><span class="lineno">  410</span>        max_today = max(today_counts.values()) <span class="keywordflow">if</span> today_counts <span class="keywordflow">else</span> 0</div>
<div class="line"><span class="lineno">  411</span>        max_first = max(first_counts.values()) <span class="keywordflow">if</span> first_counts <span class="keywordflow">else</span> 0</div>
<div class="line"><span class="lineno">  412</span>        max_all = max(all_counts.values()) <span class="keywordflow">if</span> all_counts <span class="keywordflow">else</span> 0</div>
<div class="line"><span class="lineno">  413</span> </div>
<div class="line"><span class="lineno">  414</span>        candidate_asset_ids = (</div>
<div class="line"><span class="lineno">  415</span>            set(today_counts.keys()) | set(all_counts.keys()) | set(first_counts.keys())</div>
<div class="line"><span class="lineno">  416</span>        )</div>
<div class="line"><span class="lineno">  417</span> </div>
<div class="line"><span class="lineno">  418</span>        best_asset_id = <span class="keywordtype">None</span></div>
<div class="line"><span class="lineno">  419</span>        best_score = -1.0</div>
<div class="line"><span class="lineno">  420</span>        best_tiebreak = (-1,)</div>
<div class="line"><span class="lineno">  421</span> </div>
<div class="line"><span class="lineno">  422</span>        <span class="keywordflow">for</span> aid <span class="keywordflow">in</span> candidate_asset_ids:</div>
<div class="line"><span class="lineno">  423</span>            t = today_counts.get(aid, 0)</div>
<div class="line"><span class="lineno">  424</span>            f = first_counts.get(aid, 0)</div>
<div class="line"><span class="lineno">  425</span>            a = all_counts.get(aid, 0)</div>
<div class="line"><span class="lineno">  426</span> </div>
<div class="line"><span class="lineno">  427</span>            score = 0.0</div>
<div class="line"><span class="lineno">  428</span>            <span class="keywordflow">if</span> max_today:</div>
<div class="line"><span class="lineno">  429</span>                score += 0.6 * (t / max_today)</div>
<div class="line"><span class="lineno">  430</span>            <span class="keywordflow">if</span> max_first:</div>
<div class="line"><span class="lineno">  431</span>                score += 0.25 * (f / max_first)</div>
<div class="line"><span class="lineno">  432</span>            <span class="keywordflow">if</span> max_all:</div>
<div class="line"><span class="lineno">  433</span>                score += 0.15 * (a / max_all)</div>
<div class="line"><span class="lineno">  434</span> </div>
<div class="line"><span class="lineno">  435</span>            tiebreak = (t, a, -aid <span class="keywordflow">if</span> isinstance(aid, int) <span class="keywordflow">else</span> 0)</div>
<div class="line"><span class="lineno">  436</span>            <span class="keywordflow">if</span> score &gt; best_score <span class="keywordflow">or</span> (</div>
<div class="line"><span class="lineno">  437</span>                abs(score - best_score) &lt; 1e-9 <span class="keywordflow">and</span> tiebreak &gt; best_tiebreak</div>
<div class="line"><span class="lineno">  438</span>            ):</div>
<div class="line"><span class="lineno">  439</span>                best_score = score</div>
<div class="line"><span class="lineno">  440</span>                best_asset_id = aid</div>
<div class="line"><span class="lineno">  441</span>                best_tiebreak = tiebreak</div>
<div class="line"><span class="lineno">  442</span> </div>
<div class="line"><span class="lineno">  443</span>        <span class="keywordflow">if</span> best_asset_id <span class="keywordflow">is</span> <span class="keywordflow">not</span> <span class="keywordtype">None</span>:</div>
<div class="line"><span class="lineno">  444</span>            asset = Asset.objects.get(id=best_asset_id)</div>
<div class="line"><span class="lineno">  445</span>            best_asset_payload = {<span class="stringliteral">&quot;slug&quot;</span>: asset.slug, <span class="stringliteral">&quot;name&quot;</span>: asset.name}</div>
<div class="line"><span class="lineno">  446</span> </div>
<div class="line"><span class="lineno">  447</span>    <span class="keywordflow">return</span> Response(</div>
<div class="line"><span class="lineno">  448</span>        {</div>
<div class="line"><span class="lineno">  449</span>            <span class="stringliteral">&quot;best_asset&quot;</span>: best_asset_payload,</div>
<div class="line"><span class="lineno">  450</span>            <span class="stringliteral">&quot;views_today&quot;</span>: views_today,</div>
<div class="line"><span class="lineno">  451</span>            <span class="stringliteral">&quot;views_all_time&quot;</span>: views_all_time,</div>
<div class="line"><span class="lineno">  452</span>        }</div>
<div class="line"><span class="lineno">  453</span>    )</div>
</div><!-- fragment -->
</div>
</div>
<a id="a5e599b8ed90c3b72ba2ed946841f2675" name="a5e599b8ed90c3b72ba2ed946841f2675"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a5e599b8ed90c3b72ba2ed946841f2675">&#9670;&#160;</a></span>user_email()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.user_email </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>request</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">@brief Привязывает email к сессии и пользователю, пересчитывает баллы.

@param request: JSON с полями `session_id`, `email`
@return Данные пользователя и его суммарный балл.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00198">198</a></p>
<div class="fragment"><div class="line"><span class="lineno">  198</span><span class="keyword">def </span>user_email(request):</div>
<div class="line"><span class="lineno">  199</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  200</span><span class="stringliteral">    @brief Привязывает email к сессии и пользователю, пересчитывает баллы.</span></div>
<div class="line"><span class="lineno">  201</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  202</span><span class="stringliteral">    @param request: JSON с полями `session_id`, `email`</span></div>
<div class="line"><span class="lineno">  203</span><span class="stringliteral">    @return Данные пользователя и его суммарный балл.</span></div>
<div class="line"><span class="lineno">  204</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  205</span>    session_id = request.data.get(<span class="stringliteral">&quot;session_id&quot;</span>)</div>
<div class="line"><span class="lineno">  206</span>    email = request.data.get(<span class="stringliteral">&quot;email&quot;</span>)</div>
<div class="line"><span class="lineno">  207</span>    <span class="keywordflow">if</span> <span class="keywordflow">not</span> session_id <span class="keywordflow">or</span> <span class="keywordflow">not</span> email:</div>
<div class="line"><span class="lineno">  208</span>        <span class="keywordflow">return</span> Response({<span class="stringliteral">&quot;detail&quot;</span>: <span class="stringliteral">&quot;session_id and email are required&quot;</span>}, status=400)</div>
<div class="line"><span class="lineno">  209</span>    session = get_object_or_404(Session, id=session_id)</div>
<div class="line"><span class="lineno">  210</span>    user, _ = User.objects.get_or_create(email=email)</div>
<div class="line"><span class="lineno">  211</span>    session.user = user</div>
<div class="line"><span class="lineno">  212</span>    session.pending_email = email</div>
<div class="line"><span class="lineno">  213</span>    session.last_seen = timezone.now()</div>
<div class="line"><span class="lineno">  214</span>    session.save(update_fields=[<span class="stringliteral">&quot;user&quot;</span>, <span class="stringliteral">&quot;pending_email&quot;</span>, <span class="stringliteral">&quot;last_seen&quot;</span>])</div>
<div class="line"><span class="lineno">  215</span>    ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  216</span>        session=session,</div>
<div class="line"><span class="lineno">  217</span>        asset=<span class="keywordtype">None</span>,</div>
<div class="line"><span class="lineno">  218</span>        event_type=<span class="stringliteral">&quot;email_submitted&quot;</span>,</div>
<div class="line"><span class="lineno">  219</span>        raw_payload={<span class="stringliteral">&quot;email&quot;</span>: email},</div>
<div class="line"><span class="lineno">  220</span>    )</div>
<div class="line"><span class="lineno">  221</span>    user.total_score = _compute_user_total_score(user)</div>
<div class="line"><span class="lineno">  222</span>    user.save(update_fields=[<span class="stringliteral">&quot;total_score&quot;</span>])</div>
<div class="line"><span class="lineno">  223</span>    promo_code = _issue_promocode_if_completed(session)</div>
<div class="line"><span class="lineno">  224</span>    <span class="keywordflow">if</span> promo_code:</div>
<div class="line"><span class="lineno">  225</span>        PromoCode.objects.filter(code=promo_code).update(user=user, email=email)</div>
<div class="line"><span class="lineno">  226</span>        <span class="keywordflow">try</span>:</div>
<div class="line"><span class="lineno">  227</span>            send_promocode_email.delay(promo_code)</div>
<div class="line"><span class="lineno">  228</span>        <span class="keywordflow">except</span> Exception:  <span class="comment"># noqa: BLE001</span></div>
<div class="line"><span class="lineno">  229</span>            logger.exception(<span class="stringliteral">&quot;Как оно вообще тут упало? Увольте бэкэндера&quot;</span>)</div>
<div class="line"><span class="lineno">  230</span>    <span class="keywordflow">return</span> Response(</div>
<div class="line"><span class="lineno">  231</span>        {</div>
<div class="line"><span class="lineno">  232</span>            <span class="stringliteral">&quot;session_id&quot;</span>: str(session.id),</div>
<div class="line"><span class="lineno">  233</span>            <span class="stringliteral">&quot;user_id&quot;</span>: str(user.id),</div>
<div class="line"><span class="lineno">  234</span>            <span class="stringliteral">&quot;email&quot;</span>: user.email,</div>
<div class="line"><span class="lineno">  235</span>            <span class="stringliteral">&quot;user_total_score&quot;</span>: user.total_score,</div>
<div class="line"><span class="lineno">  236</span>        },</div>
<div class="line"><span class="lineno">  237</span>        status=status.HTTP_200_OK,</div>
<div class="line"><span class="lineno">  238</span>    )</div>
<div class="line"><span class="lineno">  239</span> </div>
<div class="line"><span class="lineno">  240</span> </div>
<div class="line"><span class="lineno">  241</span><span class="preprocessor">@api_view([&quot;GET&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a id="a6019b86cf7f3207de1daababecf3fd05" name="a6019b86cf7f3207de1daababecf3fd05"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a6019b86cf7f3207de1daababecf3fd05">&#9670;&#160;</a></span>view_event()</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.view_event </td>
          <td>(</td>
          <td class="paramtype"></td>          <td class="paramname"><span class="paramname"><em>request</em></span></td><td>)</td>
          <td></td>
        </tr>
      </table>
</div><div class="memdoc">
<pre class="fragment">@brief Регистрирует просмотр актива и начисляет очки за первый просмотр.

@param request: JSON с полями `session_id`, `asset_slug` и доп. payload
@return Информация о начисленных очках и текущем счёте сессии.
</pre> 
<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00144">144</a></p>
<div class="fragment"><div class="line"><span class="lineno">  144</span><span class="keyword">def </span>view_event(request):</div>
<div class="line"><span class="lineno">  145</span>    <span class="stringliteral">&quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  146</span><span class="stringliteral">    @brief Регистрирует просмотр актива и начисляет очки за первый просмотр.</span></div>
<div class="line"><span class="lineno">  147</span><span class="stringliteral"></span> </div>
<div class="line"><span class="lineno">  148</span><span class="stringliteral">    @param request: JSON с полями `session_id`, `asset_slug` и доп. payload</span></div>
<div class="line"><span class="lineno">  149</span><span class="stringliteral">    @return Информация о начисленных очках и текущем счёте сессии.</span></div>
<div class="line"><span class="lineno">  150</span><span class="stringliteral">    &quot;&quot;&quot;</span></div>
<div class="line"><span class="lineno">  151</span>    session_id = request.data.get(<span class="stringliteral">&quot;session_id&quot;</span>)</div>
<div class="line"><span class="lineno">  152</span>    asset_slug = request.data.get(<span class="stringliteral">&quot;asset_slug&quot;</span>)</div>
<div class="line"><span class="lineno">  153</span>    <span class="keywordflow">if</span> <span class="keywordflow">not</span> session_id <span class="keywordflow">or</span> <span class="keywordflow">not</span> asset_slug:</div>
<div class="line"><span class="lineno">  154</span>        <span class="keywordflow">return</span> Response(</div>
<div class="line"><span class="lineno">  155</span>            {<span class="stringliteral">&quot;detail&quot;</span>: <span class="stringliteral">&quot;session_id and asset_slug are required&quot;</span>}, status=400</div>
<div class="line"><span class="lineno">  156</span>        )</div>
<div class="line"><span class="lineno">  157</span>    session = get_object_or_404(Session, id=session_id)</div>
<div class="line"><span class="lineno">  158</span>    asset = get_object_or_404(Asset, slug=asset_slug)</div>
<div class="line"><span class="lineno">  159</span>    ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  160</span>        session=session,</div>
<div class="line"><span class="lineno">  161</span>        asset=asset,</div>
<div class="line"><span class="lineno">  162</span>        raw_payload=request.data,</div>
<div class="line"><span class="lineno">  163</span>    )</div>
<div class="line"><span class="lineno">  164</span>    sip, created = SessionItemProgress.objects.get_or_create(</div>
<div class="line"><span class="lineno">  165</span>        session=session, asset=asset</div>
<div class="line"><span class="lineno">  166</span>    )</div>
<div class="line"><span class="lineno">  167</span>    awarded_points = 0</div>
<div class="line"><span class="lineno">  168</span>    <span class="keywordflow">if</span> sip.times_viewed == 0:</div>
<div class="line"><span class="lineno">  169</span>        sip.viewed_at = timezone.now()</div>
<div class="line"><span class="lineno">  170</span>        awarded_points = FIRST_VIEW_POINTS</div>
<div class="line"><span class="lineno">  171</span>        session.score = session.score + FIRST_VIEW_POINTS</div>
<div class="line"><span class="lineno">  172</span>        ViewEvent.objects.create(</div>
<div class="line"><span class="lineno">  173</span>            session=session,</div>
<div class="line"><span class="lineno">  174</span>            asset=asset,</div>
<div class="line"><span class="lineno">  175</span>            event_type=<span class="stringliteral">&quot;first_view_awarded&quot;</span>,</div>
<div class="line"><span class="lineno">  176</span>            raw_payload={</div>
<div class="line"><span class="lineno">  177</span>                <span class="stringliteral">&quot;asset_slug&quot;</span>: asset.slug,</div>
<div class="line"><span class="lineno">  178</span>                <span class="stringliteral">&quot;awarded_points&quot;</span>: FIRST_VIEW_POINTS,</div>
<div class="line"><span class="lineno">  179</span>            },</div>
<div class="line"><span class="lineno">  180</span>        )</div>
<div class="line"><span class="lineno">  181</span>    sip.times_viewed = sip.times_viewed + 1</div>
<div class="line"><span class="lineno">  182</span>    sip.save()</div>
<div class="line"><span class="lineno">  183</span>    session.last_seen = timezone.now()</div>
<div class="line"><span class="lineno">  184</span>    session.save(update_fields=[<span class="stringliteral">&quot;score&quot;</span>, <span class="stringliteral">&quot;last_seen&quot;</span>])</div>
<div class="line"><span class="lineno">  185</span>    promo_code = _issue_promocode_if_completed(session, return_existing=<span class="keyword">False</span>)</div>
<div class="line"><span class="lineno">  186</span>    payload = {</div>
<div class="line"><span class="lineno">  187</span>        <span class="stringliteral">&quot;session_id&quot;</span>: str(session.id),</div>
<div class="line"><span class="lineno">  188</span>        <span class="stringliteral">&quot;asset_slug&quot;</span>: asset.slug,</div>
<div class="line"><span class="lineno">  189</span>        <span class="stringliteral">&quot;awarded_points&quot;</span>: awarded_points,</div>
<div class="line"><span class="lineno">  190</span>        <span class="stringliteral">&quot;session_score&quot;</span>: session.score,</div>
<div class="line"><span class="lineno">  191</span>    }</div>
<div class="line"><span class="lineno">  192</span>    <span class="keywordflow">if</span> promo_code:</div>
<div class="line"><span class="lineno">  193</span>        payload[<span class="stringliteral">&quot;promo_code&quot;</span>] = promo_code</div>
<div class="line"><span class="lineno">  194</span>    <span class="keywordflow">return</span> Response(payload, status=status.HTTP_200_OK)</div>
<div class="line"><span class="lineno">  195</span> </div>
<div class="line"><span class="lineno">  196</span> </div>
<div class="line"><span class="lineno">  197</span><span class="preprocessor">@api_view([&quot;POST&quot;])</span></div>
</div><!-- fragment -->
</div>
</div>
<a name="doc-var-members" id="doc-var-members"></a><h2 id="header-doc-var-members" class="groupheader">Переменные</h2>
<a id="a3f26b2a1ff2af012cb33d6edde8aaffe" name="a3f26b2a1ff2af012cb33d6edde8aaffe"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a3f26b2a1ff2af012cb33d6edde8aaffe">&#9670;&#160;</a></span>FIRST_VIEW_POINTS</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int arb.views.FIRST_VIEW_POINTS = 10</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00034">34</a></p>

</div>
</div>
<a id="a9c8988c8437bedf9564fca3d5c0767d2" name="a9c8988c8437bedf9564fca3d5c0767d2"></a>
<h2 class="memtitle"><span class="permalink"><a href="#a9c8988c8437bedf9564fca3d5c0767d2">&#9670;&#160;</a></span>logger</h2>

<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">arb.views.logger = logging.getLogger(__name__)</td>
        </tr>
      </table>
</div><div class="memdoc">

<p class="definition">См. определение в файле <a class="el" href="views_8py_source.html">views.py</a> строка <a class="el" href="views_8py_source.html#l00032">32</a></p>

</div>
</div>
</div><!-- contents -->
</div><!-- doc-content -->
<div id="page-nav" class="page-nav-panel">
<div id="page-nav-resize-handle"></div>
<div id="page-nav-tree">
<div id="page-nav-contents">
</div><!-- page-nav-contents -->
</div><!-- page-nav-tree -->
</div><!-- page-nav -->
</div><!-- container -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a href="namespacearb.html">arb</a></li><li class="navelem"><a href="namespacearb_1_1views.html">views</a></li>
    <li class="footer">Документация по LCTAR Backend. Последние изменения: <span class="timestamp"></span>. Создано системой <a href="https://www.doxygen.org/index.html"><img class="footer" src="doxygen.svg" width="104" height="31" alt="doxygen"/></a> 1.14.0 </li>
  </ul>
</div>
</body>
</html>
